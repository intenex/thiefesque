!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=105)}([function(t,e,i){"use strict";const s=2.3283064365386963e-10;class r{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*s,t=69069*t+1>>>0,this._s1=t*s,t=69069*t+1>>>0,this._s2=t*s,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*s;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,r;do{r=(i=2*this.getUniform()-1)*i+(s=2*this.getUniform()-1)*s}while(r>1||0==r);return t+i*Math.sqrt(-2*Math.log(r)/r)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,r=0;for(i in t)if(s<(r+=t[i]))return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new r).setState(this.getState())}}e.a=(new r).setSeed(Date.now())},function(t,e,i){"use strict";function s(t,e){return(t%e+e)%e}function r(t,e=0,i=1){return t<e?e:t>i?i:t}function n(t){return t.charAt(0).toUpperCase()+t.substring(1)}function o(t,...e){let i=o.map;return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(s,r,o,a){if("%"==t.charAt(a-1))return s.substring(1);if(!e.length)return s;let h=e[0],l=(r||o).split(","),c=l.shift()||"",u=i[c.toLowerCase()];if(!u)return s;let p=(h=e.shift())[u].apply(h,l),d=c.charAt(0);return d!=d.toLowerCase()&&(p=n(p)),p})}i.r(e),i.d(e,"mod",function(){return s}),i.d(e,"clamp",function(){return r}),i.d(e,"capitalize",function(){return n}),i.d(e,"format",function(){return o}),o.map={s:"toString"}},function(t,e){t.exports=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}},function(t,e,i){"use strict";i.r(e),i.d(e,"fromString",function(){return n}),i.d(e,"add",function(){return o}),i.d(e,"add_",function(){return a}),i.d(e,"multiply",function(){return h}),i.d(e,"multiply_",function(){return l}),i.d(e,"interpolate",function(){return c}),i.d(e,"lerp",function(){return u}),i.d(e,"interpolateHSL",function(){return p}),i.d(e,"lerpHSL",function(){return d}),i.d(e,"randomize",function(){return g}),i.d(e,"rgb2hsl",function(){return f}),i.d(e,"hsl2rgb",function(){return m}),i.d(e,"toRGB",function(){return y}),i.d(e,"toHex",function(){return b});var s=i(1),r=i(0);function n(t){let e,i;if(t in v)e=v[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];v[t]=e}return e.slice()}function o(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let s=0;s<e.length;s++)i[t]+=e[s][t];return i}function a(t,...e){for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}function h(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let s=0;s<e.length;s++)i[t]*=e[s][t]/255;i[t]=Math.round(i[t])}return i}function l(t,...e){for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t}function c(t,e,i=.5){let s=t.slice();for(let r=0;r<3;r++)s[r]=Math.round(s[r]+i*(e[r]-t[r]));return s}const u=c;function p(t,e,i=.5){let s=f(t),r=f(e);for(let t=0;t<3;t++)s[t]+=i*(r[t]-s[t]);return m(s)}const d=p;function g(t,e){e instanceof Array||(e=Math.round(r.a.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(r.a.getNormal(0,e[t])):e;return i}function f(t){let e,i=t[0]/255,s=t[1]/255,r=t[2]/255,n=Math.max(i,s,r),o=Math.min(i,s,r),a=0,h=(n+o)/2;if(n==o)e=0;else{let t=n-o;switch(e=h>.5?t/(2-n-o):t/(n+o),n){case i:a=(s-r)/t+(s<r?6:0);break;case s:a=(r-i)/t+2;break;case r:a=(i-s)/t+4}a/=6}return[a,e,h]}function _(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function m(t){let e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];{let i=t[1],s=e<.5?e*(1+i):e+i-e*i,r=2*e-s,n=_(r,s,t[0]+1/3),o=_(r,s,t[0]),a=_(r,s,t[0]-1/3);return[Math.round(255*n),Math.round(255*o),Math.round(255*a)]}}function y(t){return`rgb(${t.map(t=>Object(s.clamp)(t,0,255)).join(",")})`}function b(t){return`#${t.map(t=>Object(s.clamp)(t,0,255).toString(16).padStart(2,"0")).join("")}`}const v={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},function(t,e,i){var s=i(24),r="object"==typeof self&&self&&self.Object===Object&&self,n=s||r||Function("return this")();t.exports=n},function(t,e){t.exports=function(t,e){return t===e||t!=t&&e!=e}},function(t,e){t.exports=function(t){return null!=t&&"object"==typeof t}},function(t,e,i){var s=i(23),r=i(47),n=i(48),o="[object Null]",a="[object Undefined]",h=s?s.toStringTag:void 0;t.exports=function(t){return null==t?void 0===t?a:o:h&&h in Object(t)?r(t):n(t)}},function(t,e,i){var s=i(65),r=i(66),n=i(67),o=i(68),a=i(69);function h(t){var e=-1,i=null==t?0:t.length;for(this.clear();++e<i;){var s=t[e];this.set(s[0],s[1])}}h.prototype.clear=s,h.prototype.delete=r,h.prototype.get=n,h.prototype.has=o,h.prototype.set=a,t.exports=h},function(t,e,i){var s=i(5);t.exports=function(t,e){for(var i=t.length;i--;)if(s(t[i][0],e))return i;return-1}},function(t,e,i){var s=i(13)(Object,"create");t.exports=s},function(t,e,i){var s=i(84);t.exports=function(t,e){var i=t.__data__;return s(e)?i["string"==typeof e?"string":"hash"]:i.map}},function(t,e,i){"use strict";i.d(e,"a",function(){return s});class s{getContainer(){return null}setOptions(t){this._options=t}}},function(t,e,i){var s=i(45),r=i(52);t.exports=function(t,e){var i=r(t,e);return s(i)?i:void 0}},function(t,e,i){var s=i(7),r=i(2),n="[object AsyncFunction]",o="[object Function]",a="[object GeneratorFunction]",h="[object Proxy]";t.exports=function(t){if(!r(t))return!1;var e=s(t);return e==o||e==a||e==n||e==h}},function(t,e,i){var s=i(14),r=i(26);t.exports=function(t){return null!=t&&r(t.length)&&!s(t)}},function(t,e,i){var s=i(54),r=i(61),n=i(15);t.exports=function(t){return n(t)?s(t,!0):r(t)}},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),t.webpackPolyfill=1),t}},function(t,e,i){var s=i(22);t.exports=function(t,e,i){"__proto__"==e&&s?s(t,e,{configurable:!0,enumerable:!0,value:i,writable:!0}):t[e]=i}},function(t,e,i){"use strict";(function(t){i.d(e,"a",function(){return o});var s=i(12),r=i(3);function n(t){let e=r.fromString(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class o extends s.a{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){t.stdout.write(`[0;48;5;${n(this._options.bg)}m[2J`)}draw(e,i){let[s,r,o,a,h]=e,l=this._offset[0]+s,c=this._offset[1]+r,u=this.computeSize();if(l<0||l>=u[0])return;if(c<0||c>=u[1])return;if(l===this._cursor[0]&&c===this._cursor[1]||(t.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(l,c)),this._cursor[0]=l,this._cursor[1]=c),i&&(o||(o=" ")),!o)return;let p=function(t,e){return`[0;38;5;${n(t)};48;5;${n(e)}m`}(a,h);p!==this._lastColor&&(t.stdout.write(p),this._lastColor=p);let d=[].concat(o);t.stdout.write(d[0]),this._cursor[0]++,this._cursor[0]>=u[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[t.stdout.columns,t.stdout.rows]}}}).call(this,i(39))},function(t,e,i){var s=i(21),r=i(40),n=i(42);t.exports=function(t,e){return n(r(t,e,s),t+"")}},function(t,e){t.exports=function(t){return t}},function(t,e,i){var s=i(13),r=function(){try{var t=s(Object,"defineProperty");return t({},"",{}),t}catch(t){}}();t.exports=r},function(t,e,i){var s=i(4).Symbol;t.exports=s},function(t,e,i){(function(e){var i="object"==typeof e&&e&&e.Object===Object&&e;t.exports=i}).call(this,i(46))},function(t,e,i){var s=i(5),r=i(15),n=i(27),o=i(2);t.exports=function(t,e,i){if(!o(i))return!1;var a=typeof e;return!!("number"==a?r(i)&&n(e,i.length):"string"==a&&e in i)&&s(i[e],t)}},function(t,e){var i=9007199254740991;t.exports=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=i}},function(t,e){var i=9007199254740991,s=/^(?:0|[1-9]\d*)$/;t.exports=function(t,e){var r=typeof t;return!!(e=null==e?i:e)&&("number"==r||"symbol"!=r&&s.test(t))&&t>-1&&t%1==0&&t<e}},function(t,e,i){var s=i(56),r=i(6),n=Object.prototype,o=n.hasOwnProperty,a=n.propertyIsEnumerable,h=s(function(){return arguments}())?s:function(t){return r(t)&&o.call(t,"callee")&&!a.call(t,"callee")};t.exports=h},function(t,e){var i=Array.isArray;t.exports=i},function(t,e,i){(function(t){var s=i(4),r=i(57),n=e&&!e.nodeType&&e,o=n&&"object"==typeof t&&t&&!t.nodeType&&t,a=o&&o.exports===n?s.Buffer:void 0,h=(a?a.isBuffer:void 0)||r;t.exports=h}).call(this,i(17)(t))},function(t,e,i){var s=i(58),r=i(59),n=i(60),o=n&&n.isTypedArray,a=o?r(o):s;t.exports=a},function(t,e){var i=Object.prototype;t.exports=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||i)}},function(t,e,i){var s=i(13)(i(4),"Map");t.exports=s},function(t,e,i){var s=i(18),r=i(5);t.exports=function(t,e,i){(void 0===i||r(t[e],i))&&(void 0!==i||e in t)||s(t,e,i)}},function(t,e,i){var s=i(98)(Object.getPrototypeOf,Object);t.exports=s},function(t,e){t.exports=function(t,e){if("__proto__"!=e)return t[e]}},function(t,e,i){var s=i(20),r=i(5),n=i(25),o=i(16),a=Object.prototype,h=a.hasOwnProperty,l=s(function(t,e){t=Object(t);var i=-1,s=e.length,l=s>2?e[2]:void 0;for(l&&n(e[0],e[1],l)&&(s=1);++i<s;)for(var c=e[i],u=o(c),p=-1,d=u.length;++p<d;){var g=u[p],f=t[g];(void 0===f||r(f,a[g])&&!h.call(t,g))&&(t[g]=c[g])}return t});t.exports=l},function(t,e,i){var s=i(63),r=i(104)(function(t,e,i){s(t,e,i)});t.exports=r},function(t,e){var i,s,r=t.exports={};function n(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===n||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:n}catch(t){i=n}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(t){s=o}}();var h,l=[],c=!1,u=-1;function p(){c&&h&&(c=!1,h.length?l=h.concat(l):u=-1,l.length&&d())}function d(){if(!c){var t=a(p);c=!0;for(var e=l.length;e;){for(h=l,l=[];++u<e;)h&&h[u].run();u=-1,e=l.length}h=null,c=!1,function(t){if(s===clearTimeout)return clearTimeout(t);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(t);try{s(t)}catch(e){try{return s.call(null,t)}catch(e){return s.call(this,t)}}}(t)}}function g(t,e){this.fun=t,this.array=e}function f(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];l.push(new g(t,e)),1!==l.length||c||a(d)},g.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,i){var s=i(41),r=Math.max;t.exports=function(t,e,i){return e=r(void 0===e?t.length-1:e,0),function(){for(var n=arguments,o=-1,a=r(n.length-e,0),h=Array(a);++o<a;)h[o]=n[e+o];o=-1;for(var l=Array(e+1);++o<e;)l[o]=n[o];return l[e]=i(h),s(t,this,l)}}},function(t,e){t.exports=function(t,e,i){switch(i.length){case 0:return t.call(e);case 1:return t.call(e,i[0]);case 2:return t.call(e,i[0],i[1]);case 3:return t.call(e,i[0],i[1],i[2])}return t.apply(e,i)}},function(t,e,i){var s=i(43),r=i(53)(s);t.exports=r},function(t,e,i){var s=i(44),r=i(22),n=i(21),o=r?function(t,e){return r(t,"toString",{configurable:!0,enumerable:!1,value:s(e),writable:!0})}:n;t.exports=o},function(t,e){t.exports=function(t){return function(){return t}}},function(t,e,i){var s=i(14),r=i(49),n=i(2),o=i(51),a=/^\[object .+?Constructor\]$/,h=Function.prototype,l=Object.prototype,c=h.toString,u=l.hasOwnProperty,p=RegExp("^"+c.call(u).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");t.exports=function(t){return!(!n(t)||r(t))&&(s(t)?p:a).test(o(t))}},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){var s=i(23),r=Object.prototype,n=r.hasOwnProperty,o=r.toString,a=s?s.toStringTag:void 0;t.exports=function(t){var e=n.call(t,a),i=t[a];try{t[a]=void 0;var s=!0}catch(t){}var r=o.call(t);return s&&(e?t[a]=i:delete t[a]),r}},function(t,e){var i=Object.prototype.toString;t.exports=function(t){return i.call(t)}},function(t,e,i){var s,r=i(50),n=(s=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||""))?"Symbol(src)_1."+s:"";t.exports=function(t){return!!n&&n in t}},function(t,e,i){var s=i(4)["__core-js_shared__"];t.exports=s},function(t,e){var i=Function.prototype.toString;t.exports=function(t){if(null!=t){try{return i.call(t)}catch(t){}try{return t+""}catch(t){}}return""}},function(t,e){t.exports=function(t,e){return null==t?void 0:t[e]}},function(t,e){var i=800,s=16,r=Date.now;t.exports=function(t){var e=0,n=0;return function(){var o=r(),a=s-(o-n);if(n=o,a>0){if(++e>=i)return arguments[0]}else e=0;return t.apply(void 0,arguments)}}},function(t,e,i){var s=i(55),r=i(28),n=i(29),o=i(30),a=i(27),h=i(31),l=Object.prototype.hasOwnProperty;t.exports=function(t,e){var i=n(t),c=!i&&r(t),u=!i&&!c&&o(t),p=!i&&!c&&!u&&h(t),d=i||c||u||p,g=d?s(t.length,String):[],f=g.length;for(var _ in t)!e&&!l.call(t,_)||d&&("length"==_||u&&("offset"==_||"parent"==_)||p&&("buffer"==_||"byteLength"==_||"byteOffset"==_)||a(_,f))||g.push(_);return g}},function(t,e){t.exports=function(t,e){for(var i=-1,s=Array(t);++i<t;)s[i]=e(i);return s}},function(t,e,i){var s=i(7),r=i(6),n="[object Arguments]";t.exports=function(t){return r(t)&&s(t)==n}},function(t,e){t.exports=function(){return!1}},function(t,e,i){var s=i(7),r=i(26),n=i(6),o={};o["[object Float32Array]"]=o["[object Float64Array]"]=o["[object Int8Array]"]=o["[object Int16Array]"]=o["[object Int32Array]"]=o["[object Uint8Array]"]=o["[object Uint8ClampedArray]"]=o["[object Uint16Array]"]=o["[object Uint32Array]"]=!0,o["[object Arguments]"]=o["[object Array]"]=o["[object ArrayBuffer]"]=o["[object Boolean]"]=o["[object DataView]"]=o["[object Date]"]=o["[object Error]"]=o["[object Function]"]=o["[object Map]"]=o["[object Number]"]=o["[object Object]"]=o["[object RegExp]"]=o["[object Set]"]=o["[object String]"]=o["[object WeakMap]"]=!1,t.exports=function(t){return n(t)&&r(t.length)&&!!o[s(t)]}},function(t,e){t.exports=function(t){return function(e){return t(e)}}},function(t,e,i){(function(t){var s=i(24),r=e&&!e.nodeType&&e,n=r&&"object"==typeof t&&t&&!t.nodeType&&t,o=n&&n.exports===r&&s.process,a=function(){try{var t=n&&n.require&&n.require("util").types;return t||o&&o.binding&&o.binding("util")}catch(t){}}();t.exports=a}).call(this,i(17)(t))},function(t,e,i){var s=i(2),r=i(32),n=i(62),o=Object.prototype.hasOwnProperty;t.exports=function(t){if(!s(t))return n(t);var e=r(t),i=[];for(var a in t)("constructor"!=a||!e&&o.call(t,a))&&i.push(a);return i}},function(t,e){t.exports=function(t){var e=[];if(null!=t)for(var i in Object(t))e.push(i);return e}},function(t,e,i){var s=i(64),r=i(34),n=i(88),o=i(90),a=i(2),h=i(16),l=i(36);t.exports=function t(e,i,c,u,p){e!==i&&n(i,function(n,h){if(a(n))p||(p=new s),o(e,i,h,c,t,u,p);else{var d=u?u(l(e,h),n,h+"",e,i,p):void 0;void 0===d&&(d=n),r(e,h,d)}},h)}},function(t,e,i){var s=i(8),r=i(70),n=i(71),o=i(72),a=i(73),h=i(74);function l(t){var e=this.__data__=new s(t);this.size=e.size}l.prototype.clear=r,l.prototype.delete=n,l.prototype.get=o,l.prototype.has=a,l.prototype.set=h,t.exports=l},function(t,e){t.exports=function(){this.__data__=[],this.size=0}},function(t,e,i){var s=i(9),r=Array.prototype.splice;t.exports=function(t){var e=this.__data__,i=s(e,t);return!(i<0||(i==e.length-1?e.pop():r.call(e,i,1),--this.size,0))}},function(t,e,i){var s=i(9);t.exports=function(t){var e=this.__data__,i=s(e,t);return i<0?void 0:e[i][1]}},function(t,e,i){var s=i(9);t.exports=function(t){return s(this.__data__,t)>-1}},function(t,e,i){var s=i(9);t.exports=function(t,e){var i=this.__data__,r=s(i,t);return r<0?(++this.size,i.push([t,e])):i[r][1]=e,this}},function(t,e,i){var s=i(8);t.exports=function(){this.__data__=new s,this.size=0}},function(t,e){t.exports=function(t){var e=this.__data__,i=e.delete(t);return this.size=e.size,i}},function(t,e){t.exports=function(t){return this.__data__.get(t)}},function(t,e){t.exports=function(t){return this.__data__.has(t)}},function(t,e,i){var s=i(8),r=i(33),n=i(75),o=200;t.exports=function(t,e){var i=this.__data__;if(i instanceof s){var a=i.__data__;if(!r||a.length<o-1)return a.push([t,e]),this.size=++i.size,this;i=this.__data__=new n(a)}return i.set(t,e),this.size=i.size,this}},function(t,e,i){var s=i(76),r=i(83),n=i(85),o=i(86),a=i(87);function h(t){var e=-1,i=null==t?0:t.length;for(this.clear();++e<i;){var s=t[e];this.set(s[0],s[1])}}h.prototype.clear=s,h.prototype.delete=r,h.prototype.get=n,h.prototype.has=o,h.prototype.set=a,t.exports=h},function(t,e,i){var s=i(77),r=i(8),n=i(33);t.exports=function(){this.size=0,this.__data__={hash:new s,map:new(n||r),string:new s}}},function(t,e,i){var s=i(78),r=i(79),n=i(80),o=i(81),a=i(82);function h(t){var e=-1,i=null==t?0:t.length;for(this.clear();++e<i;){var s=t[e];this.set(s[0],s[1])}}h.prototype.clear=s,h.prototype.delete=r,h.prototype.get=n,h.prototype.has=o,h.prototype.set=a,t.exports=h},function(t,e,i){var s=i(10);t.exports=function(){this.__data__=s?s(null):{},this.size=0}},function(t,e){t.exports=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}},function(t,e,i){var s=i(10),r="__lodash_hash_undefined__",n=Object.prototype.hasOwnProperty;t.exports=function(t){var e=this.__data__;if(s){var i=e[t];return i===r?void 0:i}return n.call(e,t)?e[t]:void 0}},function(t,e,i){var s=i(10),r=Object.prototype.hasOwnProperty;t.exports=function(t){var e=this.__data__;return s?void 0!==e[t]:r.call(e,t)}},function(t,e,i){var s=i(10),r="__lodash_hash_undefined__";t.exports=function(t,e){var i=this.__data__;return this.size+=this.has(t)?0:1,i[t]=s&&void 0===e?r:e,this}},function(t,e,i){var s=i(11);t.exports=function(t){var e=s(this,t).delete(t);return this.size-=e?1:0,e}},function(t,e){t.exports=function(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t}},function(t,e,i){var s=i(11);t.exports=function(t){return s(this,t).get(t)}},function(t,e,i){var s=i(11);t.exports=function(t){return s(this,t).has(t)}},function(t,e,i){var s=i(11);t.exports=function(t,e){var i=s(this,t),r=i.size;return i.set(t,e),this.size+=i.size==r?0:1,this}},function(t,e,i){var s=i(89)();t.exports=s},function(t,e){t.exports=function(t){return function(e,i,s){for(var r=-1,n=Object(e),o=s(e),a=o.length;a--;){var h=o[t?a:++r];if(!1===i(n[h],h,n))break}return e}}},function(t,e,i){var s=i(34),r=i(91),n=i(92),o=i(95),a=i(96),h=i(28),l=i(29),c=i(99),u=i(30),p=i(14),d=i(2),g=i(100),f=i(31),_=i(36),m=i(101);t.exports=function(t,e,i,y,b,v,x){var w=_(t,i),k=_(e,i),M=x.get(k);if(M)s(t,i,M);else{var S=v?v(w,k,i+"",t,e,x):void 0,A=void 0===S;if(A){var T=l(k),C=!T&&u(k),E=!T&&!C&&f(k);S=k,T||C||E?l(w)?S=w:c(w)?S=o(w):C?(A=!1,S=r(k,!0)):E?(A=!1,S=n(k,!0)):S=[]:g(k)||h(k)?(S=w,h(w)?S=m(w):d(w)&&!p(w)||(S=a(k))):A=!1}A&&(x.set(k,S),b(S,k,y,v,x),x.delete(k)),s(t,i,S)}}},function(t,e,i){(function(t){var s=i(4),r=e&&!e.nodeType&&e,n=r&&"object"==typeof t&&t&&!t.nodeType&&t,o=n&&n.exports===r?s.Buffer:void 0,a=o?o.allocUnsafe:void 0;t.exports=function(t,e){if(e)return t.slice();var i=t.length,s=a?a(i):new t.constructor(i);return t.copy(s),s}}).call(this,i(17)(t))},function(t,e,i){var s=i(93);t.exports=function(t,e){var i=e?s(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.length)}},function(t,e,i){var s=i(94);t.exports=function(t){var e=new t.constructor(t.byteLength);return new s(e).set(new s(t)),e}},function(t,e,i){var s=i(4).Uint8Array;t.exports=s},function(t,e){t.exports=function(t,e){var i=-1,s=t.length;for(e||(e=Array(s));++i<s;)e[i]=t[i];return e}},function(t,e,i){var s=i(97),r=i(35),n=i(32);t.exports=function(t){return"function"!=typeof t.constructor||n(t)?{}:s(r(t))}},function(t,e,i){var s=i(2),r=Object.create,n=function(){function t(){}return function(e){if(!s(e))return{};if(r)return r(e);t.prototype=e;var i=new t;return t.prototype=void 0,i}}();t.exports=n},function(t,e){t.exports=function(t,e){return function(i){return t(e(i))}}},function(t,e,i){var s=i(15),r=i(6);t.exports=function(t){return r(t)&&s(t)}},function(t,e,i){var s=i(7),r=i(35),n=i(6),o="[object Object]",a=Function.prototype,h=Object.prototype,l=a.toString,c=h.hasOwnProperty,u=l.call(Object);t.exports=function(t){if(!n(t)||s(t)!=o)return!1;var e=r(t);if(null===e)return!0;var i=c.call(e,"constructor")&&e.constructor;return"function"==typeof i&&i instanceof i&&l.call(i)==u}},function(t,e,i){var s=i(102),r=i(16);t.exports=function(t){return s(t,r(t))}},function(t,e,i){var s=i(103),r=i(18);t.exports=function(t,e,i,n){var o=!i;i||(i={});for(var a=-1,h=e.length;++a<h;){var l=e[a],c=n?n(i[l],t[l],l,i,t):void 0;void 0===c&&(c=t[l]),o?r(i,l,c):s(i,l,c)}return i}},function(t,e,i){var s=i(18),r=i(5),n=Object.prototype.hasOwnProperty;t.exports=function(t,e,i){var o=t[e];n.call(t,e)&&r(o,i)&&(void 0!==i||e in t)||s(t,e,i)}},function(t,e,i){var s=i(20),r=i(25);t.exports=function(t){return s(function(e,i){var s=-1,n=i.length,o=n>1?i[n-1]:void 0,a=n>2?i[2]:void 0;for(o=t.length>3&&"function"==typeof o?(n--,o):void 0,a&&r(i[0],i[1],a)&&(o=n<3?void 0:o,n=1),e=Object(e);++s<n;){var h=i[s];h&&t(e,h,s,o)}return e})}},function(t,e,i){"use strict";i.r(e);var s={};i.r(s),i.d(s,"TYPE_TEXT",function(){return d}),i.d(s,"TYPE_NEWLINE",function(){return g}),i.d(s,"TYPE_FG",function(){return f}),i.d(s,"TYPE_BG",function(){return _}),i.d(s,"measure",function(){return m}),i.d(s,"tokenize",function(){return y});var r=i(0),n=i(12);class o extends n.a{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}var a=i(1);class h extends o{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,r,n,o]=t,a=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=o,this._fill(a[0],a[1])),!r)return;this._ctx.fillStyle=n;let h=[].concat(r);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],a[0],Math.ceil(a[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),r=Math.min(i,s),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let a=o/100,h=2*(r=Math.floor(r)+1)/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return e=Math.floor(e/s),Object(a.mod)(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-i+s,e),r.lineTo(t-i/2+s,e+this._spacingX-s),r.lineTo(t+i/2-s,e+this._spacingX-s),r.lineTo(t+i-s,e),r.lineTo(t+i/2-s,e-this._spacingX+s),r.lineTo(t-i/2+s,e-this._spacingX+s),r.lineTo(t-i+s,e)):(r.moveTo(t,e-i+s),r.lineTo(t+this._spacingX-s,e-i/2+s),r.lineTo(t+this._spacingX-s,e+i/2-s),r.lineTo(t,e+i-s),r.lineTo(t-this._spacingX+s,e+i/2-s),r.lineTo(t-this._spacingX+s,e-i/2+s),r.lineTo(t,e-i+s)),r.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class l extends o{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){l.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,r,n,o]=t,a=""+r+n+o;if(a in this._canvasCache)e=this._canvasCache[a];else{let t=this._options.border,i=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=o,i.fillRect(t,t,e.width-t,e.height-t),r){i.fillStyle=n,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(r);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,r,n,o]=t;if(e){let t=this._options.border;this._ctx.fillStyle=o,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!r)return;this._ctx.fillStyle=n;let a=[].concat(r);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let n=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let o=n/100*s/i;return o>1&&(s=Math.floor(s/o)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}l.cache=!1;class c extends o{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,r,n,o]=t,a=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*a,s*h,a,h):(this._ctx.fillStyle=o,this._ctx.fillRect(i*a,s*h,a,h))),!r)return;let l=[].concat(r),c=[].concat(n),u=[].concat(o);for(let t=0;t<l.length;t++){let e=this._options.tileMap[l[t]];if(!e)throw new Error(`Char "${l[t]}" not found in tileMap`);if(this._options.tileColorize){let r=this._colorCanvas,n=r.getContext("2d");n.globalCompositeOperation="source-over",n.clearRect(0,0,a,h);let o=c[t],l=u[t];n.drawImage(this._options.tileSet,e[0],e[1],a,h,0,0,a,h),"transparent"!=o&&(n.fillStyle=o,n.globalCompositeOperation="source-atop",n.fillRect(0,0,a,h)),"transparent"!=l&&(n.fillStyle=l,n.globalCompositeOperation="destination-over",n.fillRect(0,0,a,h)),this._ctx.drawImage(r,i*a,s*h,a,h)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],a,h,i*a,s*h,a,h)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}var u=i(19);const p=/%([bc]){([^}]*)}/g,d=0,g=1,f=2,_=3;function m(t,e){let i={width:0,height:1},s=y(t,e),r=0;for(let t=0;t<s.length;t++){let e=s[t];switch(e.type){case d:r+=e.value.length;break;case g:i.height++,i.width=Math.max(i.width,r),r=0}}return i.width=Math.max(i.width,r),i}function y(t,e){let i=[],s=0;t.replace(p,function(e,r,n,o){let a=t.substring(s,o);return a.length&&i.push({type:d,value:a}),i.push({type:"c"==r?f:_,value:n.trim()}),s=o+e.length,""});let r=t.substring(s);return r.length&&i.push({type:d,value:r}),function(t,e){e||(e=1/0);let i=0,s=0,r=-1;for(;i<t.length;){let n=t[i];if(n.type==g&&(s=0,r=-1),n.type!=d){i++;continue}for(;0==s&&" "==n.value.charAt(0);)n.value=n.value.substring(1);let o=n.value.indexOf("\n");if(-1!=o){n.value=b(t,i,o,!0);let e=n.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();n.value=e.join("")}if(n.value.length){if(s+n.value.length>e){let o=-1;for(;;){let t=n.value.indexOf(" ",o+1);if(-1==t)break;if(s+t>e)break;o=t}if(-1!=o)n.value=b(t,i,o,!0);else if(-1!=r){let e=t[r],s=e.value.lastIndexOf(" ");e.value=b(t,r,s,!0),i=r}else n.value=b(t,i,e-s,!1)}else s+=n.value.length,-1!=n.value.indexOf(" ")&&(r=i);i++}else t.splice(i,1)}t.push({type:g});let n=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case d:n=i;break;case g:if(n){let t=n.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();n.value=t.join("")}n=null}}return t.pop(),t}(i,e)}function b(t,e,i,s){let r={type:g},n={type:d,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,r,n),t[e].value.substring(0,i)}let v=80,x=25;const w={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},k=13,M=32,S={hex:h,rect:l,tile:c,term:u.a},A={width:v,height:x,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class T{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},A,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=S[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,r){s||(s=this._options.fg),r||(r=this._options.bg);let n=`${t},${e}`;this._data[n]=[t,e,i,s,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[n]=!0)}drawText(t,e,i,s){let r=null,n=null,o=t,a=e,h=1;s||(s=this._options.width-t);let l=y(i,s);for(;l.length;){let e=l.shift();switch(e.type){case d:let i=!1,s=!1,l=!1,c=!1;for(let t=0;t<e.value.length;t++){let h=e.value.charCodeAt(t),u=e.value.charAt(t);l=h>65280&&h<65377||h>65500&&h<65512||h>65518,i=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!c||l||i||o++,l&&!s&&o++,this.draw(o++,a,u,r,n),s=i,c=l}break;case f:r=e.value||null;break;case _:n=e.value||null;break;case g:o=t,a++,h++}}return h}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}T.Rect=l,T.Hex=h,T.Tile=c,T.Term=u.a;class C{constructor(){this._time=0,this._events=[],this._eventTimes=[]}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(t,e){let i=this._events.length;for(let t=0;t<this._eventTimes.length;t++)if(this._eventTimes[t]>e){i=t;break}this._events.splice(i,0,t),this._eventTimes.splice(i,0,e)}get(){if(!this._events.length)return null;let t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(let e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]}getEventTime(t){let e=this._events.indexOf(t);if(-1!=e)return this._eventTimes[e]}remove(t){let e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)}_remove(t){this._events.splice(t,1),this._eventTimes.splice(t,1)}}class E{constructor(){this._queue=new C,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}var P={Simple:class extends E{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}},Speed:class extends E{add(t,e,i){return this._queue.add(t,void 0!==i?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}},Action:class extends E{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}};class O{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,r,n,o=[];switch(this._options.topology){case 4:r=1,n=[0,1],s=[w[8][7],w[8][1],w[8][3],w[8][5]];break;case 6:s=w[6],r=1,n=[-1,1];break;case 8:s=w[4],r=2,n=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let a=t+n[0]*i,h=e+n[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*r;e++)o.push([a,h]),a+=s[t][0],h+=s[t][1];return o}}const R=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];var I={DiscreteShadowcasting:class extends O{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let r,n,o,a,h,l=[];for(let c=1;c<=i;c++){let i=this._getCircle(t,e,c),u=360/i.length;for(let t=0;t<i.length;t++)if(o=i[t][0],a=i[t][1],n=(r=u*(t-.5))+u,h=!this._lightPasses(o,a),this._visibleCoords(Math.floor(r),Math.ceil(n),h,l)&&s(o,a,c,1),2==l.length&&0==l[0]&&360==l[1])return}}_visibleCoords(t,e,i,s){if(t<0){let r=this._visibleCoords(0,e,i,s),n=this._visibleCoords(360+t,360,i,s);return r||n}let r=0;for(;r<s.length&&s[r]<t;)r++;if(r==s.length)return i&&s.push(t,e),!0;let n=0;if(r%2){for(;r<s.length&&s[r]<e;)r++,n++;return 0!=n&&(i&&(n%2?s.splice(r-n,n,e):s.splice(r-n,n)),!0)}for(;r<s.length&&s[r]<e;)r++,n++;return(t!=s[r-n]||1!=n)&&(i&&(n%2?s.splice(r-n,n,t):s.splice(r-n,n,t,e)),!0)}},PreciseShadowcasting:class extends O{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let r,n,o,a,h,l,c=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),p=i.length;for(let t=0;t<p;t++)if(r=i[t][0],n=i[t][1],a=[t?2*t-1:2*p-1,2*p],h=[2*t+1,2*p],o=!this._lightPasses(r,n),(l=this._checkVisibility(a,h,o,c))&&s(r,n,u,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let r=0,n=!1;for(;r<s.length;){let e=s[r],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||r%2||(n=!0);break}r++}let o=s.length,a=!1;for(;o--;){let t=s[o],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&o%2&&(a=!0);break}}let h,l=!0;if(r==o&&(n||a)?l=!1:n&&a&&r+1==o&&o%2?l=!1:r>o&&r%2&&(l=!1),!l)return 0;let c=o-r+1;if(c%2)if(r%2){let t=s[r];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c,e)}else{let e=s[o];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c,t)}else{if(!(r%2))return i&&s.splice(r,c,t,e),1;{let t=s[r],e=s[o];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c)}}return h/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}},RecursiveShadowcasting:class extends O{compute(t,e,i,s){s(t,e,0,1);for(let r=0;r<R.length;r++)this._renderOctant(t,e,R[r],i,s)}compute180(t,e,i,s,r){r(t,e,0,1);let n=(s-1+8)%8,o=(s-2+8)%8,a=(s+1+8)%8;this._renderOctant(t,e,R[o],i,r),this._renderOctant(t,e,R[n],i,r),this._renderOctant(t,e,R[s],i,r),this._renderOctant(t,e,R[a],i,r)}compute90(t,e,i,s,r){r(t,e,0,1);let n=(s-1+8)%8;this._renderOctant(t,e,R[s],i,r),this._renderOctant(t,e,R[n],i,r)}_renderOctant(t,e,i,s,r){this._castVisibility(t,e,1,1,0,s+1,i[0],i[1],i[2],i[3],r)}_castVisibility(t,e,i,s,r,n,o,a,h,l,c){if(!(s<r))for(let u=i;u<=n;u++){let i=-u-1,p=-u,d=!1,g=0;for(;i<=0;){let f=t+(i+=1)*o+p*a,_=e+i*h+p*l,m=(i-.5)/(p+.5),y=(i+.5)/(p-.5);if(!(y>s)){if(m<r)break;if(i*i+p*p<n*n&&c(f,_,u,1),d){if(!this._lightPasses(f,_)){g=y;continue}d=!1,s=g}else!this._lightPasses(f,_)&&u<n&&(d=!0,this._castVisibility(t,e,u+1,s,m,n,o,a,h,l,c),g=y)}}if(d)break}}}};class D{constructor(t=v,e=x){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let s=0;s<this._height;s++)e[i].push(t)}return e}}class Y extends D{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class j{}class W extends j{constructor(t,e,i,s,r,n){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=s,this._doors={},void 0!==r&&void 0!==n&&this.addDoor(r,n)}static createRandomAt(t,e,i,s,n){let o=n.roomWidth[0],a=n.roomWidth[1],h=r.a.getUniformInt(o,a);o=n.roomHeight[0],a=n.roomHeight[1];let l=r.a.getUniformInt(o,a);if(1==i){let i=e-Math.floor(r.a.getUniform()*l);return new this(t+1,i,t+h,i+l-1,t,e)}if(-1==i){let i=e-Math.floor(r.a.getUniform()*l);return new this(t-h,i,t-1,i+l-1,t,e)}if(1==s){let i=t-Math.floor(r.a.getUniform()*h);return new this(i,e+1,i+h-1,e+l,t,e)}if(-1==s){let i=t-Math.floor(r.a.getUniform()*h);return new this(i,e-l,i+h-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let s=i.roomWidth[0],n=i.roomWidth[1],o=r.a.getUniformInt(s,n);s=i.roomHeight[0],n=i.roomHeight[1];let a=r.a.getUniformInt(s,n),h=t-Math.floor(r.a.getUniform()*o),l=e-Math.floor(r.a.getUniform()*a);return new this(h,l,h+o-1,l+a-1)}static createRandom(t,e,i){let s=i.roomWidth[0],n=i.roomWidth[1],o=r.a.getUniformInt(s,n);s=i.roomHeight[0],n=i.roomHeight[1];let a=r.a.getUniformInt(s,n),h=t-o-1,l=e-a-1,c=1+Math.floor(r.a.getUniform()*h),u=1+Math.floor(r.a.getUniform()*l);return new this(c,u,c+o-1,u+a-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,r=this._y2+1;for(let n=e;n<=i;n++)for(let o=s;o<=r;o++)n!=e&&n!=i&&o!=s&&o!=r||t(n,o)||this.addDoor(n,o);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,s=this._x2+1,r=this._y1-1,n=this._y2+1;for(let o=i;o<=s;o++)for(let a=r;a<=n;a++)if(o==i||o==s||a==r||a==n){if(!t(o,a))return!1}else if(!e(o,a))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,r=this._y2+1,n=0;for(let o=e;o<=i;o++)for(let a=s;a<=r;a++)t(o,a,n=o+","+a in this._doors?2:o==e||o==i||a==s||a==r?1:0)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class X extends j{constructor(t,e,i,s){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=s,this._endsWithAWall=!0}static createRandomAt(t,e,i,s,n){let o=n.corridorLength[0],a=n.corridorLength[1],h=r.a.getUniformInt(o,a);return new this(t,e,t+i*h,e+s*h)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,s=this._startY,r=this._endX-i,n=this._endY-s,o=1+Math.max(Math.abs(r),Math.abs(n));r&&(r/=Math.abs(r)),n&&(n/=Math.abs(n));let a=n,h=-r,l=!0;for(let c=0;c<o;c++){let u=i+c*r,p=s+c*n;if(e(u,p)||(l=!1),t(u+a,p+h)||(l=!1),t(u-a,p-h)||(l=!1),!l){o=c,this._endX=u-r,this._endY=p-n;break}}if(0==o)return!1;if(1==o&&t(this._endX+r,this._endY+n))return!1;let c=!t(this._endX+r+a,this._endY+n+h),u=!t(this._endX+r-a,this._endY+n-h);return this._endsWithAWall=t(this._endX+r,this._endY+n),!c&&!u||!this._endsWithAWall}create(t){let e=this._startX,i=this._startY,s=this._endX-e,r=this._endY-i,n=1+Math.max(Math.abs(s),Math.abs(r));s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));for(let o=0;o<n;o++){t(e+o*s,i+o*r,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,s=this._endX-e,r=this._endY-i;s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));let n=r,o=-s;t(this._endX+s,this._endY+r),t(this._endX+n,this._endY+o),t(this._endX-n,this._endY-o)}}const $={room:W,corridor:X};function z(t,e,i){i[e[t+1]]=i[t],e[i[t]]=e[t+1],i[t]=t+1,e[t+1]=t}function F(t,e,i){i[e[t]]=i[t],e[i[t]]=e[t],i[t]=t,e[t]=t}var H={Arena:class extends D{create(t){let e=this._width-1,i=this._height-1;for(let s=0;s<=e;s++)for(let r=0;r<=i;r++)t(s,r,s&&r&&s<e&&r<i?0:1);return this}},Uniform:class extends Y{constructor(t,e,i){super(t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,i),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(t){let e=Date.now();for(;;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this}_generateRooms(){let t,e=this._width-2,i=this._height-2;do{if(t=this._generateRoom(),this._dug/(e*i)>this._options.roomDugPercentage)break}while(t)}_generateRoom(){let t=0;for(;t<this._roomAttempts;){t++;let e=W.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null}_generateCorridors(){let t=0;for(;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(let t=0;t<this._rooms.length;t++){let e=this._rooms[t];e.clearDoors(),e.create(this._digCallback)}for(this._unconnected=r.a.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let t=r.a.getItem(this._connected);if(!t)break;let e=this._closestRoom(this._unconnected,t);if(!e)break;let i=this._closestRoom(this._connected,e);if(!i)break;if(!this._connectRooms(e,i))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(t,e){let i=1/0,s=e.getCenter(),r=null;for(let e=0;e<t.length;e++){let n=t[e],o=n.getCenter(),a=o[0]-s[0],h=o[1]-s[1],l=a*a+h*h;l<i&&(i=l,r=n)}return r}_connectRooms(t,e){let i,s,r,n,o,a,h,l=t.getCenter(),c=e.getCenter(),u=c[0]-l[0],p=c[1]-l[1];if(Math.abs(u)<Math.abs(p)?(n=(2+(r=p>0?2:0))%4,o=e.getLeft(),a=e.getRight(),h=0):(n=(2+(r=u>0?1:3))%4,o=e.getTop(),a=e.getBottom(),h=1),!(i=this._placeInWall(t,r)))return!1;if(i[h]>=o&&i[h]<=a){s=i.slice();let t=0;switch(n){case 0:t=e.getTop()-1;break;case 1:t=e.getRight()+1;break;case 2:t=e.getBottom()+1;break;case 3:t=e.getLeft()-1}s[(h+1)%2]=t,this._digLine([i,s])}else if(i[h]<o-1||i[h]>a+1){let t=i[h]-c[h],r=0;switch(n){case 0:case 1:r=t<0?3:1;break;case 2:case 3:r=t<0?1:3}if(n=(n+r)%4,!(s=this._placeInWall(e,n)))return!1;let o=[0,0];o[h]=i[h];let a=(h+1)%2;o[a]=s[a],this._digLine([i,o,s])}else{let t=(h+1)%2;if(!(s=this._placeInWall(e,n)))return!1;let r=Math.round((s[t]+i[t])/2),o=[0,0],a=[0,0];o[h]=i[h],o[t]=r,a[h]=s[h],a[t]=r,this._digLine([i,o,a,s])}return t.addDoor(i[0],i[1]),e.addDoor(s[0],s[1]),-1!=(h=this._unconnected.indexOf(t))&&(this._unconnected.splice(h,1),this._connected.push(t)),-1!=(h=this._unconnected.indexOf(e))&&(this._unconnected.splice(h,1),this._connected.push(e)),!0}_placeInWall(t,e){let i=[0,0],s=[0,0],n=0;switch(e){case 0:s=[1,0],i=[t.getLeft(),t.getTop()-1],n=t.getRight()-t.getLeft()+1;break;case 1:s=[0,1],i=[t.getRight()+1,t.getTop()],n=t.getBottom()-t.getTop()+1;break;case 2:s=[1,0],i=[t.getLeft(),t.getBottom()+1],n=t.getRight()-t.getLeft()+1;break;case 3:s=[0,1],i=[t.getLeft()-1,t.getTop()],n=t.getBottom()-t.getTop()+1}let o=[],a=-2;for(let t=0;t<n;t++){let e=i[0]+t*s[0],r=i[1]+t*s[1];o.push(null),1==this._map[e][r]?a!=t-1&&(o[t]=[e,r]):(a=t,t&&(o[t-1]=null))}for(let t=o.length-1;t>=0;t--)o[t]||o.splice(t,1);return o.length?r.a.getItem(o):null}_digLine(t){for(let e=1;e<t.length;e++){let i=t[e-1],s=t[e],r=new X(i[0],i[1],s[0],s[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(t,e,i){this._map[t][e]=i,0==i&&this._dug++}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}},Cellular:class extends D{constructor(t,e,i={}){super(t,e),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(i),this._dirs=w[this._options.topology],this._map=this._fillMap(0)}randomize(t){for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)this._map[e][i]=r.a.getUniform()<t?1:0;return this}setOptions(t){Object.assign(this._options,t)}set(t,e,i){this._map[t][e]=i}create(t){let e=this._fillMap(0),i=this._options.born,s=this._options.survive;for(let t=0;t<this._height;t++){let r=1,n=0;6==this._options.topology&&(r=2,n=t%2);for(let o=n;o<this._width;o+=r){let r=this._map[o][t],n=this._getNeighbors(o,t);r&&-1!=s.indexOf(n)?e[o][t]=1:r||-1==i.indexOf(n)||(e[o][t]=1)}}this._map=e,t&&this._serviceCallback(t)}_serviceCallback(t){for(let e=0;e<this._height;e++){let i=1,s=0;6==this._options.topology&&(i=2,s=e%2);for(let r=s;r<this._width;r+=i)t(r,e,this._map[r][e])}}_getNeighbors(t,e){let i=0;for(let s=0;s<this._dirs.length;s++){let r=this._dirs[s],n=t+r[0],o=e+r[1];n<0||n>=this._width||o<0||o>=this._height||(i+=1==this._map[n][o]?1:0)}return i}connect(t,e,i){e||(e=0);let s=[],n={},o=1,a=[0,0];6==this._options.topology&&(o=2,a=[0,1]);for(let t=0;t<this._height;t++)for(let i=a[t%2];i<this._width;i+=o)if(this._freeSpace(i,t,e)){let e=[i,t];n[this._pointKey(e)]=e,s.push([i,t])}let h=s[r.a.getUniformInt(0,s.length-1)],l=this._pointKey(h),c={};for(c[l]=h,delete n[l],this._findConnected(c,n,[h],!1,e);Object.keys(n).length>0;){let t=this._getFromTo(c,n),s=t[0],r=t[1],o={};o[this._pointKey(s)]=s,this._findConnected(o,n,[s],!0,e),(6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected).call(this,r,s,c,n,e,i);for(let t in o){let i=o[t];this._map[i[0]][i[1]]=e,c[t]=i,delete n[t]}}t&&this._serviceCallback(t)}_getFromTo(t,e){let i,s=[0,0],n=[0,0],o=Object.keys(t),a=Object.keys(e);for(let h=0;h<5;h++){if(o.length<a.length){let i=o;n=t[i[r.a.getUniformInt(0,i.length-1)]],s=this._getClosest(n,e)}else{let i=a;s=e[i[r.a.getUniformInt(0,i.length-1)]],n=this._getClosest(s,t)}if((i=(s[0]-n[0])*(s[0]-n[0])+(s[1]-n[1])*(s[1]-n[1]))<64)break}return[s,n]}_getClosest(t,e){let i=null,s=null;for(let r in e){let n=e[r],o=(n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1]);(null==s||o<s)&&(s=o,i=n)}return i}_findConnected(t,e,i,s,r){for(;i.length>0;){let n,o=i.splice(0,1)[0];n=6==this._options.topology?[[o[0]+2,o[1]],[o[0]+1,o[1]-1],[o[0]-1,o[1]-1],[o[0]-2,o[1]],[o[0]-1,o[1]+1],[o[0]+1,o[1]+1]]:[[o[0]+1,o[1]],[o[0]-1,o[1]],[o[0],o[1]+1],[o[0],o[1]-1]];for(let o=0;o<n.length;o++){let a=this._pointKey(n[o]);null==t[a]&&this._freeSpace(n[o][0],n[o][1],r)&&(t[a]=n[o],s||delete e[a],i.push(n[o]))}}}_tunnelToConnected(t,e,i,s,r,n){let o,a;e[0]<t[0]?(o=e,a=t):(o=t,a=e);for(let t=o[0];t<=a[0];t++){this._map[t][o[1]]=r;let e=[t,o[1]],n=this._pointKey(e);i[n]=e,delete s[n]}n&&o[0]<a[0]&&n(o,[a[0],o[1]]);let h=a[0];e[1]<t[1]?(o=e,a=t):(o=t,a=e);for(let t=o[1];t<a[1];t++){this._map[h][t]=r;let e=[h,t],n=this._pointKey(e);i[n]=e,delete s[n]}n&&o[1]<a[1]&&n([a[0],o[1]],[a[0],a[1]])}_tunnelToConnected6(t,e,i,s,r,n){let o,a;e[0]<t[0]?(o=e,a=t):(o=t,a=e);let h=o[0],l=o[1];for(;h!=a[0]||l!=a[1];){let t=2;l<a[1]?(l++,t=1):l>a[1]&&(l--,t=1),h<a[0]?h+=t:h>a[0]?h-=t:a[1]%2?h-=t:h+=t,this._map[h][l]=r;let e=[h,l],n=this._pointKey(e);i[n]=e,delete s[n]}n&&n(e,t)}_freeSpace(t,e,i){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==i}_pointKey(t){return t[0]+"."+t[1]}},Digger:class extends Y{constructor(t,e,i={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let i,s=Date.now();do{if(i=0,Date.now()-s>this._options.timeLimit)break;let t=this._findWall();if(!t)break;let e=t.split(","),r=parseInt(e[0]),n=parseInt(e[1]),o=this._getDiggingDirection(r,n);if(!o)continue;let a=0;do{if(a++,this._tryFeature(r,n,o[0],o[1])){this._removeSurroundingWalls(r,n),this._removeSurroundingWalls(r-o[0],n-o[1]);break}}while(a<this._featureAttempts);for(let t in this._walls)this._walls[t]>1&&i++}while(this._dug/e<this._options.dugPercentage||i);if(this._addDoors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this._walls={},this._map=[],this}_digCallback(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=W.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)}_findWall(){let t=[],e=[];for(let i in this._walls)2==this._walls[i]?e.push(i):t.push(i);let i=e.length?e:t;if(!i.length)return null;let s=r.a.getItem(i.sort());return delete this._walls[s],s}_tryFeature(t,e,i,s){let n=r.a.getWeightedValue(this._features),o=$[n].createRandomAt(t,e,i,s,this._options);return!!o.isValid(this._isWallCallback,this._canBeDugCallback)&&(o.create(this._digCallback),o instanceof W&&this._rooms.push(o),o instanceof X&&(o.createPriorityWalls(this._priorityWallCallback),this._corridors.push(o)),!0)}_removeSurroundingWalls(t,e){let i=w[4];for(let s=0;s<i.length;s++){let r=i[s],n=t+r[0],o=e+r[1];delete this._walls[n+","+o],n=t+2*r[0],o=e+2*r[1],delete this._walls[n+","+o]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let i=null,s=w[4];for(let r=0;r<s.length;r++){let n=s[r],o=t+n[0],a=e+n[1];if(!this._map[o][a]){if(i)return null;i=n}}return i?[-i[0],-i[1]]:null}_addDoors(){let t=this._map;function e(e,i){return 1==t[e][i]}for(let t=0;t<this._rooms.length;t++){let i=this._rooms[t];i.clearDoors(),i.addDoors(e)}}},EllerMaze:class extends D{create(t){let e,i=this._fillMap(1),s=Math.ceil((this._width-2)/2),n=[],o=[];for(let t=0;t<s;t++)n.push(t),o.push(t);for(n.push(s-1),e=1;e+3<this._height;e+=2)for(let t=0;t<s;t++){let s=2*t+1,a=e;i[s][a]=0,t!=n[t+1]&&r.a.getUniform()>.375&&(z(t,n,o),i[s+1][a]=0),t!=n[t]&&r.a.getUniform()>.375?F(t,n,o):i[s][a+1]=0}for(let t=0;t<s;t++){let s=2*t+1,a=e;i[s][a]=0,t!=n[t+1]&&(t==n[t]||r.a.getUniform()>.375)&&(z(t,n,o),i[s+1][a]=0),F(t,n,o)}for(let e=0;e<this._width;e++)for(let s=0;s<this._height;s++)t(e,s,i[e][s]);return this}},DividedMaze:class extends D{constructor(){super(...arguments),this._stack=[],this._map=[]}create(t){let e=this._width,i=this._height;this._map=[];for(let t=0;t<e;t++){this._map.push([]);for(let s=0;s<i;s++){let r=0==t||0==s||t+1==e||s+1==i;this._map[t].push(r?1:0)}}this._stack=[[1,1,e-2,i-2]],this._process();for(let s=0;s<e;s++)for(let e=0;e<i;e++)t(s,e,this._map[s][e]);return this._map=[],this}_process(){for(;this._stack.length;){let t=this._stack.shift();this._partitionRoom(t)}}_partitionRoom(t){let e=[],i=[];for(let i=t[0]+1;i<t[2];i++){let s=this._map[i][t[1]-1],r=this._map[i][t[3]+1];!s||!r||i%2||e.push(i)}for(let e=t[1]+1;e<t[3];e++){let s=this._map[t[0]-1][e],r=this._map[t[2]+1][e];!s||!r||e%2||i.push(e)}if(!e.length||!i.length)return;let s=r.a.getItem(e),n=r.a.getItem(i);this._map[s][n]=1;let o=[],a=[];o.push(a);for(let e=t[0];e<s;e++)this._map[e][n]=1,a.push([e,n]);a=[],o.push(a);for(let e=s+1;e<=t[2];e++)this._map[e][n]=1,a.push([e,n]);a=[],o.push(a);for(let e=t[1];e<n;e++)this._map[s][e]=1,a.push([s,e]);a=[],o.push(a);for(let e=n+1;e<=t[3];e++)this._map[s][e]=1,a.push([s,e]);let h=r.a.getItem(o);for(let t=0;t<o.length;t++){let e=o[t];if(e==h)continue;let i=r.a.getItem(e);this._map[i[0]][i[1]]=0}this._stack.push([t[0],t[1],s-1,n-1]),this._stack.push([s+1,t[1],t[2],n-1]),this._stack.push([t[0],n+1,s-1,t[3]]),this._stack.push([s+1,n+1,t[2],t[3]])}},IceyMaze:class extends D{constructor(t,e,i=0){super(t,e),this._regularity=i,this._map=[]}create(t){let e=this._width,i=this._height,s=this._fillMap(1);e-=e%2?1:2,i-=i%2?1:2;let n=0,o=0,a=0,h=0,l=0,c=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(n=1+2*Math.floor(r.a.getUniform()*(e-1)/2),o=1+2*Math.floor(r.a.getUniform()*(i-1)/2),l||(s[n][o]=0),!s[n][o]){this._randomize(u);do{0==Math.floor(r.a.getUniform()*(this._regularity+1))&&this._randomize(u),c=!0;for(let t=0;t<4;t++)if(a=n+2*u[t][0],h=o+2*u[t][1],this._isFree(s,a,h,e,i)){s[a][h]=0,s[n+u[t][0]][o+u[t][1]]=0,n=a,o=h,c=!1,l++;break}}while(!c)}}while(l+1<e*i/4);for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,s[e][i]);return this._map=[],this}_randomize(t){for(let e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(4*r.a.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}}_isFree(t,e,i,s,r){return!(e<1||i<1||e>=s||i>=r)&&t[e][i]}},Rogue:class extends D{constructor(t,e,i){super(t,e),this.map=[],this.rooms=[],this.connectedCells=[],(i=Object.assign({cellWidth:3,cellHeight:3},i)).hasOwnProperty("roomWidth")||(i.roomWidth=this._calculateRoomSize(this._width,i.cellWidth)),i.hasOwnProperty("roomHeight")||(i.roomHeight=this._calculateRoomSize(this._height,i.cellHeight)),this._options=i}create(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this}_calculateRoomSize(t,e){let i=Math.floor(t/e*.8),s=Math.floor(t/e*.25);return s<2&&(s=2),i<2&&(i=2),[s,i]}_initRooms(){for(let t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(let e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}}_connectRooms(){let t,e,i,s,n,o,a=r.a.getUniformInt(0,this._options.cellWidth-1),h=r.a.getUniformInt(0,this._options.cellHeight-1),l=!1;do{o=[0,2,4,6],o=r.a.shuffle(o);do{if(l=!1,t=o.pop(),e=a+w[8][t][0],i=h+w[8][t][1],!(e<0||e>=this._options.cellWidth||i<0||i>=this._options.cellHeight)){if((s=this.rooms[a][h]).connections.length>0&&s.connections[0][0]==e&&s.connections[0][1]==i)break;0==(n=this.rooms[e][i]).connections.length&&(n.connections.push([a,h]),this.connectedCells.push([e,i]),a=e,h=i,l=!0)}}while(o.length>0&&0==l)}while(o.length>0)}_connectUnconnectedRooms(){let t,e,i,s=this._options.cellWidth,n=this._options.cellHeight;this.connectedCells=r.a.shuffle(this.connectedCells);for(let o=0;o<this._options.cellWidth;o++)for(let a=0;a<this._options.cellHeight;a++)if(0==(t=this.rooms[o][a]).connections.length){let h=[0,2,4,6];h=r.a.shuffle(h),i=!1;do{let t=h.pop(),r=o+w[8][t][0],l=a+w[8][t][1];if(!(r<0||r>=s||l<0||l>=n)){if(i=!0,0==(e=this.rooms[r][l]).connections.length)break;for(let t=0;t<e.connections.length;t++)if(e.connections[t][0]==o&&e.connections[t][1]==a){i=!1;break}if(i)break}}while(h.length);i?t.connections.push([e.cellx,e.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){let t,e,i,s,n,o=this._width,a=this._height,h=this._options.cellWidth,l=this._options.cellHeight,c=Math.floor(this._width/h),u=Math.floor(this._height/l),p=this._options.roomWidth,d=this._options.roomHeight;for(let g=0;g<h;g++)for(let h=0;h<l;h++){if(0==(i=c*g)&&(i=1),0==(s=u*h)&&(s=1),t=r.a.getUniformInt(p[0],p[1]),e=r.a.getUniformInt(d[0],d[1]),h>0)for(n=this.rooms[g][h-1];s-(n.y+n.height)<3;)s++;if(g>0)for(n=this.rooms[g-1][h];i-(n.x+n.width)<3;)i++;let l=Math.round(r.a.getUniformInt(0,c-t)/2),f=Math.round(r.a.getUniformInt(0,u-e)/2);for(;i+l+t>=o;)l?l--:t--;for(;s+f+e>=a;)f?f--:e--;i+=l,s+=f,this.rooms[g][h].x=i,this.rooms[g][h].y=s,this.rooms[g][h].width=t,this.rooms[g][h].height=e;for(let r=i;r<i+t;r++)for(let t=s;t<s+e;t++)this.map[r][t]=0}}_getWallPosition(t,e){let i,s,n;return 1==e||3==e?(i=r.a.getUniformInt(t.x+1,t.x+t.width-2),n=1==e?1+(s=t.y-2):(s=t.y+t.height+1)-1,this.map[i][n]=0):(s=r.a.getUniformInt(t.y+1,t.y+t.height-2),n=2==e?(i=t.x+t.width+1)-1:1+(i=t.x-2),this.map[n][s]=0),[i,s]}_drawCorridor(t,e){let i,s,n,o,a=e[0]-t[0],h=e[1]-t[1],l=t[0],c=t[1],u=[],p=Math.abs(a),d=Math.abs(h),g=r.a.getUniform(),f=g,_=1-g;for(s=a>0?2:6,n=h>0?4:0,p<d?(i=Math.ceil(d*f),u.push([n,i]),u.push([s,p]),i=Math.floor(d*_),u.push([n,i])):(i=Math.ceil(p*f),u.push([s,i]),u.push([n,d]),i=Math.floor(p*_),u.push([s,i])),this.map[l][c]=0;u.length>0;)for(o=u.pop();o[1]>0;)l+=w[8][o[0]][0],c+=w[8][o[0]][1],this.map[l][c]=0,o[1]=o[1]-1}_createCorridors(){let t,e,i,s,r,n=this._options.cellWidth,o=this._options.cellHeight;for(let a=0;a<n;a++)for(let n=0;n<o;n++){t=this.rooms[a][n];for(let n=0;n<t.connections.length;n++)e=t.connections[n],(i=this.rooms[e[0]][e[1]]).cellx>t.cellx?(s=2,r=4):i.cellx<t.cellx?(s=4,r=2):i.celly>t.celly?(s=3,r=1):(s=1,r=3),this._drawCorridor(this._getWallPosition(t,s),this._getWallPosition(i,r))}}}};Math.sqrt(3),Math.sqrt(3);class V{constructor(t,e,i,s={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},s),this._dirs=w[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let s=0;s<this._dirs.length;s++){let r=this._dirs[s],n=t+r[0],o=e+r[1];this._passableCallback(n,o)&&i.push([n,o])}return i}}var L={Dijkstra:class extends V{constructor(t,e,i,s){super(t,e,i,s),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let s=t+","+e;if(s in this._computed||this._compute(t,e),!(s in this._computed))return;let r=this._computed[s];for(;r;)i(r.x,r.y),r=r.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let s=this._getNeighbors(i.x,i.y);for(let t=0;t<s.length;t++){let e=s[t],r=e[0],n=e[1];r+","+n in this._computed||this._add(r,n,i)}}}_add(t,e,i){let s={x:t,y:e,prev:i};this._computed[t+","+e]=s,this._todo.push(s)}},AStar:class extends V{constructor(t,e,i,s={}){super(t,e,i,s),this._todo=[],this._done={}}compute(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){let i=this._todo.shift(),s=i.x+","+i.y;if(s in this._done)continue;if(this._done[s]=i,i.x==t&&i.y==e)break;let r=this._getNeighbors(i.x,i.y);for(let t=0;t<r.length;t++){let e=r[t],s=e[0],n=e[1];s+","+n in this._done||this._add(s,n,i)}}let s=this._done[t+","+e];if(s)for(;s;)i(s.x,s.y),s=s.prev}_add(t,e,i){let s=this._distance(t,e),r={x:t,y:e,prev:i,g:i?i.g+1:0,h:s},n=r.g+r.h;for(let t=0;t<this._todo.length;t++){let e=this._todo[t],i=e.g+e.h;if(n<i||n==i&&s<e.h)return void this._todo.splice(t,0,r)}this._todo.push(r)}_distance(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:let i=Math.abs(t-this._fromX),s=Math.abs(e-this._fromY);return s+Math.max(0,(i-s)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}}}};class U{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}var q=i(3);const G=q;var N={getLine(t,e,i,s){const r=[],n=Math.abs(i-t),o=Math.abs(s-e),a=t<i?1:-1,h=e<s?1:-1;let l,c=n-o;for(;t!=i||e!=s;)r.push({x:t,y:e}),(l=2*c)>-n&&(c-=o,t+=a),l<n&&(c+=n,e+=h);return r.push({x:t,y:e}),r}};class Z{constructor(t){this.screen_type=t}enter(){console.log(`Entered ${this.screen_type} screen.`)}exit(){console.log(`Exited ${this.screen_type} screen.`)}handleEvent(t){}}const B=new Z("start");B.render=function(t){t.drawText(1,1,"%c{yellow}Welcome to Thiefesque. Feel free to dig around."),t.drawText(1,2,"Press [Enter] to start. Then, press [?] to access a list of commands.")},B.handleEvent=function(t){t.keyCode!==M&&t.keyCode!==k||this.game.switchScreen(this.game.screens.playScreen)};const K=new Z("play");K.gameEnded=!1,K.setGameEnded=function(t){this.gameEnded=t},K.enter=function(){this.game.maps.dungeon.getEngine().start()},K.move=function(t,e,i){const s=this.player.getX()+t,r=this.player.getY()+e,n=this.player.getZ()+i;this.player.tryMove(s,r,n),this.game.refresh(),this.player.getMap().getEngine().unlock()},K.render=function(t){if(this.subScreen)return void this.subScreen.render(t);const e=this.game.getScreenWidth(),i=this.game.getScreenHeight();this.renderTiles(t),this.player.getMessages().forEach((e,i)=>{t.drawText(0,i,`%c{white}%b{black}${e}`)});let s="%c{white}%b{black}";s+=`HP: ${this.player.getHP()}/${this.player.getMaxHP()} `,s+=`L: ${this.player.getLevel()} `,s+=`XP TO LVL: ${this.player.getNextLevelExperience()-this.player.getExperience()}`,t.drawText(0,i,s);const r=this.player.getHungerState();t.drawText(e-r.length,i,r)},K.getScreenOffsets=function(t,e,i){let s=Math.max(0,this.player.getX()-Math.floor(e/2));s=Math.min(s,t.getWidth()-e);let r=Math.max(0,this.player.getY()-Math.floor(i/2));return{x:s,y:r=Math.min(r,t.getHeight()-i)}},K.renderTiles=function(t){const e=this.game.getScreenWidth(),i=this.game.getScreenHeight(),s=this.player.getMap(),r=this.getScreenOffsets(s,e,i),n=r.x,o=r.y,a=this.player.getZ(),h={};s.getFov(a).compute(this.player.getX(),this.player.getY(),this.player.getSightRadius(),(t,e,i,r)=>{h[`${t},${e}`]=!0,s.setExplored(t,e,a,!0)});for(let r=n;r<n+e;r++)for(let e=o;e<o+i;e++)if(s.isExplored(r,e,a)){let i=s.getTile(r,e,a),l=i.getForeground();if(h[`${r},${e}`]){const t=s.getItemsAt(r,e,a);t&&(i=t[t.length-1]),s.getEntityAt(r,e,a)&&(i=s.getEntityAt(r,e,a)),l=i.getForeground()}else l="darkGray";t.draw(r-n,e-o,i.getChar(),l,i.getBackground())}},K.setSubScreen=function(t){this.subScreen=t,this.game.refresh()},K.handleEvent=function(t){if(this.subScreen)this.subScreen.handleEvent(t);else if(this.gameEnded)switch(t.key){case"Escape":this.game.switchScreen(this.game.screens.loseScreen)}else switch(t.key){case"o":case"w":case"ArrowUp":this.move(0,-1,0);break;case"p":case"e":this.move(1,-1,0);break;case";":case"d":case"ArrowRight":this.move(1,0,0);break;case"/":case"c":this.move(1,1,0);break;case".":case"x":case"ArrowDown":this.move(0,1,0);break;case",":case"z":this.move(-1,1,0);break;case"k":case"a":case"ArrowLeft":this.move(-1,0,0);break;case"i":case"q":this.move(-1,-1,0);break;case">":this.move(0,0,1);break;case"<":this.move(0,0,-1);break;case"I":this.showItemsSubScreen(this.game.screens.inventoryScreen,this.player.getItems(),"You are not carrying anything.");break;case"P":const e=this.player.getMap().getItemsAt(this.player.getX(),this.player.getY(),this.player.getZ());if(e&&1===e.length){const t=e[0];this.player.pickupItems([0])?(this.player.sendMessage(this.player,`You pick up ${t.describeA()}.`),this.game.refresh(),this.player.clearMessages()):(this.player.sendMessage(this.player,"Your inventory is full! Nothing was picked up."),this.game.refresh(),this.player.clearMessages())}else this.showItemsSubScreen(this.game.screens.pickupScreen,e,"There is nothing to pick up here.");break;case"D":this.showItemsSubScreen(this.game.screens.dropScreen,this.player.getItems(),"You have nothing to drop lol");break;case"E":this.showItemsSubScreen(this.game.screens.eatScreen,this.player.getItems(),"You have nothing to eat.");break;case"W":this.showItemsSubScreen(this.game.screens.wieldScreen,this.player.getItems(),"You have nothing to wield.");break;case"A":this.showItemsSubScreen(this.game.screens.wearScreen,this.player.getItems(),"You have nothing to wear.");break;case"X":this.showItemsSubScreen(this.game.screens.examineScreen,this.player.getItems(),"You have nothing to examine.");break;case"L":const i=this.getScreenOffsets(this.player.getMap(),this.game.getScreenWidth(),this.game.getScreenHeight());this.game.screens.lookScreen.setup(this.player,this.player.getX(),this.player.getY(),i.x,i.y),this.setSubScreen(this.game.screens.lookScreen);break;case"?":this.setSubScreen(this.game.screens.helpScreen)}},K.showItemsSubScreen=function(t,e,i){e&&t.setup(this.player,e)>0?this.setSubScreen(t):(this.player.sendMessage(this.player,i),this.game.refresh(),this.player.clearMessages())};const J=new Z("win");J.render=function(t){for(let e=0;e<22;e++){const i=Math.round(255*Math.random()),s=Math.round(255*Math.random()),r=Math.round(255*Math.random()),n=G.toRGB([i,s,r]);t.drawText(2,e+1,`%b{${n}}You win!`)}};const Q=new Z("lose");Q.render=function(t){for(let e=0;e<22;e++)t.drawText(2,e+1,"%b{red}You lose! :(")};class tt{constructor(t={}){this.caption=t.caption,this.parentScreen=t.parentScreen,this.okFunction=t.ok,this.isAcceptableFunction=t.isAcceptable||function(t){return t},this.canSelectItem=t.canSelect,this.canSelectMultipleItems=t.canSelectMultipleItems,this.hasNoItemOption=t.hasNoItemOption}setup(t,e){this.player=t;let i=0;return this.items=e.map(t=>this.isAcceptableFunction(t)?(i++,t):null),this.selectedIndices={},i}render(t){t.drawText(0,0,this.caption),this.hasNoItemOption&&t.drawText(0,1,"0 - no item");let e=0;for(let i=0;i<this.items.length;i++)if(this.items[i]){const s="abcdefghijklmnopqrstuvwxyz".substring(i,i+1),r=this.canSelectItem&&this.canSelectMultipleItems&&this.selectedIndices[i]?"+":"-";let n="";this.items[i]===this.player.getArmor()?n="(wearing)":this.items[i]===this.player.getWeapon()&&(n="(wielding)"),t.drawText(0,2+e,`${s} ${r} ${this.items[i].describe()} ${n}`),e++}}executeOkFunction(){const t={};for(const e in this.selectedIndices)t[e]=this.items[e];this.parentScreen.setSubScreen(void 0),this.okFunction(t)&&this.player.getMap().getEngine().unlock()}handleEvent(t){const e="abcdefghijklmnopqrstuvwxyz";if("Escape"===t.key)this.parentScreen.setSubScreen(void 0);else if("Enter"===t.key)this.canSelectItem&&0!==Object.keys(this.selectedIndices).length?this.executeOkFunction():this.parentScreen.setSubScreen(void 0);else if("0"===t.key&&this.canSelectItem&&this.hasNoItemOption)this.selectedIndices={},this.executeOkFunction();else if(this.canSelectItem&&e.includes(t.key)){const i=e.indexOf(t.key);this.items[i]&&(this.canSelectMultipleItems?(this.selectedIndices[i]?delete this.selectedIndices[i]:this.selectedIndices[i]=!0,this.parentScreen.game.refresh()):(this.selectedIndices[i]=!0,this.executeOkFunction()))}}}const et=new tt({parentScreen:K,caption:"Inventory",canSelect:!1}),it=new tt({parentScreen:K,caption:"Choose the items you wish to pick up",canSelect:!0,canSelectMultipleItems:!0,ok(t){return this.player.pickupItems(Object.keys(t))||this.player.sendMessage(this.player,"Your inventory is full! Not all items were picked up."),!0}}),st=new tt({parentScreen:K,caption:"Choose the item you wish to drop",canSelect:!0,canSelectMultipleItems:!1,ok(t){return this.player.dropItem(Object.keys(t)[0]),!0}}),rt=new tt({parentScreen:K,caption:"Choose the item you wish to eat",canSelect:!0,canSelectMultipleItems:!1,isAcceptable:t=>t&&t.hasMixin("Edible"),ok(t){const e=Object.keys(t)[0],i=t[e];return this.player.sendMessage(this.player,`You eat ${i.describeThe()}`),i.eat(this.player),i.hasRemainingConsumptions()||this.player.removeItem(e),!0}}),nt=new tt({parentScreen:K,caption:"Choose the item you wish to wield",canSelect:!0,canSelectionMultipleItems:!1,hasNoItemOption:!0,isAcceptable:t=>t&&t.hasMixin("Equippable")&&t.isWieldable(),ok(t){const e=Object.keys(t);if(0===e.length)this.player.unwield(),this.player.sendMessage(this.player,"You are empty handed.");else{const i=t[e[0]];this.player.unequip(i),this.player.wield(i),this.player.sendMessage(this.player,`You are wielding ${i.describeA()}`)}return!0}}),ot=new tt({parentScreen:K,caption:"Choose the item you wish to wear",canSelect:!0,canSelectMultipleItems:!1,hasNoItemOption:!0,isAcceptable:t=>t&&t.hasMixin("Equippable")&&t.isWearable(),ok(t){const e=Object.keys(t);if(0===e.length)this.player.unequip(),this.player.sendMessage(this.player,"You are not wearing anything.");else{const i=t[e[0]];this.player.unwield(i),this.player.wear(i),this.player.sendMessage(this.player,`You are wearing ${i.describeA()}`)}return!0}}),at=new tt({parentScreen:K,caption:"Choose the item you wish to examine",canSelect:!0,canSelectMultipleItems:!1,isAcceptable:t=>!0,ok(t){const e=Object.values(t);if(e.length>0){const t=e[0];this.player.sendMessage(this.player,`It's ${t.describeA(!1)} (${t.details()})`)}return!0}}),ht=new Z("stat");ht.parentScreen=K,ht.setup=function(t){this.entity=t,this.options=t.getStatOptions()},ht.render=function(t){t.drawText(0,0,"Choose a stat to increase: "),this.options.forEach((e,i)=>{t.drawText(0,i+2,`${"abcdefghijklmnopqrstuvwxyz".substring(i,i+1)} - ${e[0]} | Current value: ${e[2]()}`)}),t.drawText(0,4+this.options.length,`Remaining points: ${this.entity.getStatPoints()}`)},ht.handleEvent=function(t){const e="abcdefghijklmnopqrstuvwxyz";if(e.includes(t.key)){const i=e.indexOf(t.key);this.options[i]&&(this.options[i][1](),this.entity.setStatPoints(this.entity.getStatPoints()-1),0===this.entity.getStatPoints()?this.parentScreen.setSubScreen(void 0):this.parentScreen.game.refresh())}};const lt=new class{constructor(t={}){this.parentScreen=t.parentScreen,this.isAcceptableFunction=t.okFunction||function(t,e){return!1},this.captionFunction=t.captionFunction||function(t,e){return""}}setup(t,e,i,s,r){this.player=t,this.startX=e-s,this.startY=i-r,this.cursorX=this.startX,this.cursorY=this.startY,this.offsetX=s,this.offsetY=r,this.visibleCells={},this.player.getMap().getFov(this.player.getZ()).compute(this.player.getX(),this.player.getY(),this.player.getSightRadius(),(t,e,i,s)=>{this.visibleCells[`${t},${e}`]=!0})}render(t){this.parentScreen.renderTiles.call(this.parentScreen,t),N.getLine(this.startX,this.startY,this.cursorX,this.cursorY).forEach(e=>{t.drawText(e.x,e.y,"%c{magenta}*")}),t.drawText(0,this.parentScreen.game.getScreenHeight()-1,this.captionFunction(this.cursorX+this.offsetX,this.cursorY+this.offsetY))}handleEvent(t){switch(t.key){case"o":case"w":case"ArrowUp":this.moveCursor(0,-1);break;case"p":case"e":this.moveCursor(1,-1);break;case";":case"d":case"ArrowRight":this.moveCursor(1,0);break;case"/":case"c":this.moveCursor(1,1);break;case".":case"x":case"ArrowDown":this.moveCursor(0,1);break;case",":case"z":this.moveCursor(-1,1);break;case"k":case"a":case"ArrowLeft":this.moveCursor(-1,0);break;case"i":case"q":this.moveCursor(-1,-1);break;case"Escape":this.parentScreen.setSubScreen(void 0);break;case"Return":this.executeOkFunction()}this.parentScreen.game.refresh()}moveCursor(t,e){this.cursorX=Math.max(0,Math.min(this.cursorX+t,this.parentScreen.game.getScreenWidth())),this.cursorY=Math.max(0,Math.min(this.cursorY+e,this.parentScreen.game.getScreenHeight()-1))}executeOkFunction(){this.parentScreen.setSubScreen(void 0),this.okFunction(this.cursorX+this.offsetX,this.cursorY+this.offsetY)&&this.player.getMap().getEngine().unlock()}}({parentScreen:K,captionFunction(t,e){const i=this.player.getZ(),s=this.player.getMap();if(s.isExplored(t,e,i)){if(this.visibleCells[`${t},${e}`]){const r=s.getEntityAt(t,e,i),n=s.getItemsAt(t,e,i);if(r)return`${r.getRepresentation()} - ${r.describeA(!0)} (${r.details()})`;if(n){const t=n[n.length-1];return`${t.getRepresentation()} - ${t.describeA(!0)} (${t.details()})`}}const r=s.getTile(t,e,i);return`${r.getRepresentation()} - ${r.getDescription()}`}{const t=s.getTile(-1,-1,-1);return`${t.getRepresentation()} - ${t.getDescription()}`}}}),ct=new Z("help");ct.render=function(t){let e="thiefesque help screen",i="-----------------------";const s=this.game.getScreenWidth();let r=1;t.drawText(s/2-e.length/2,r++,e),t.drawText(s/2-i.length/2,r++,i),r++,t.drawText(0,r++,"Rumor has it that there is great treasure hidden in a cavern in this dungeon."),t.drawText(0,r++,"Find this cavern and retrieve the treasure!"),r++,e="commands",t.drawText(s/2-e.length/2,r++,e),t.drawText(s/2-i.length/2,r++,i),t.drawText(0,r++,"[P] to pick up items"),t.drawText(0,r++,"[D] to drop items"),t.drawText(0,r++,"[E] to eat items"),t.drawText(0,r++,"[W] to wield items"),t.drawText(0,r++,"[A] to wear items"),t.drawText(0,r++,"[X] to examine items"),t.drawText(0,r++,"[L] to look around you"),t.drawText(0,r++,"[?] to show this help screen"),r+=3,e="--- press any key to continue ---",t.drawText(s/2-e.length/2,r++,e)},ct.handleEvent=function(t){this.game.screens.playScreen.setSubScreen(null)};class ut{constructor(t={}){this.char=t.character||" ",this.foreground=t.foreground||"white",this.background=t.blackground||"black"}getChar(){return this.char}getForeground(){return this.foreground}getBackground(){return this.background}getRepresentation(){return`%c{${this.foreground}}%b{${this.background}}${this.char}%c{white}%b{black}`}}class pt extends ut{constructor(t={}){super(t),this.walkable=t.walkable||!1,this.diggable=t.diggable||!1,this.blocksLight=void 0===t.blocksLight||t.blocksLight,this.description=t.description||""}isWalkable(){return this.walkable}isDiggable(){return this.diggable}isBlockingLight(){return this.blocksLight}getDescription(){return this.description}}const dt=new pt({description:"(unknown)"}),gt=new pt({character:".",walkable:!0,blocksLight:!1,description:"A regular floor"}),ft=new pt({character:"#",foreground:"goldenrod",diggable:!0,blocksLight:!0,description:"A regular wall"}),_t=new pt({character:"<",foreground:"white",walkable:!0,blocksLight:!1,description:"A staircase leading upwards"}),mt=new pt({character:">",foreground:"white",walkable:!0,blocksLight:!1,description:"A staircase leading downwards"}),yt=new pt({character:"~",foreground:"blue",walkable:!1,blocksLight:!1,description:"Murky blue water"}),bt=new pt({character:"O",foreground:"white",walkable:!0,blocksLight:!1,description:"A giant ominous hole in the floor"});var vt=i(37),xt=i.n(vt);class wt extends ut{constructor(t={}){super(t),this.name=t.name||"",this.attachedMixins={},this.attachedMixinGroups={},this.listeners={},this.init={},(t.mixins||[]).forEach(e=>{if(xt()(this,e),this.attachedMixins[e.name]=!0,e.groupName&&(this.attachedMixinGroups[e.groupName]=!0),e.listeners)for(const t in e.listeners)this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e.listeners[t].bind(this));e.init&&e.init.call(this,t)})}hasMixin(t){return"object"==typeof t?this.attachedMixins[t.name]:this.attachedMixins[t]||this.attachedMixinGroups[t]}setName(t){this.name=t}getName(){return this.name}describe(){return this.name}describeA(t=!1){const e=t?["A","An"]:["a","an"],i=this.describe(),s=i.charAt(0).toLowerCase();return`${e["aeiou".includes(s)?1:0]} ${i}`}describeThe(t=!1){return`${t?"The":"the"} ${this.describe()}`}raiseEvent(t,...e){if(!this.listeners[t])return;const i=[];return this.listeners[t].forEach(t=>i.push(t(...e))),i}details(){const t=[],e=this.raiseEvent("details");return e&&e.forEach(e=>{e.forEach(e=>{t.push(`${e.key}: ${e.value}`)})}),t.sort().join(", ")}}class kt extends wt{constructor(t={},e){super(t),this.game=e,this.alive=!0,this.speed=t.speed||1e3,this.x=t.x||0,this.z=t.z||0,this.y=t.y||0,this.map=null}setMap(t){this.map=t}getMap(){return this.map}switchMap(t){if(t===this.getMap())return;this.getMap().destroyEntity(this),this.setMap(void 0);const e=t.getRandomFloorPosition(0);this.setPosition(e.x,e.y,0),t.addEntity(this),t.getEngine().start()}setSpeed(t){this.speed=t}getSpeed(){return this.speed}setX(t){this.x=t}setY(t){this.y=t}setZ(t){this.z=t}getZ(){return this.z}getX(){return this.x}getY(){return this.y}setPosition(t,e,i){const s=this.x,r=this.y,n=this.z;this.x=t,this.y=e,this.z=i,this.map&&this.map.updateEntityPosition(this,s,r,n)}isAlive(){return this.alive}kill(t="You have died!"){this.alive&&(this.alive=!1,this.sendMessage(this,t),this.hasMixin("PlayerActor")?this.act():this.getMap().destroyEntity(this))}tryMove(t,e,i=this.getZ()){const s=this.getMap(),r=s.getTile(t,e,this.getZ()),n=s.getEntityAt(t,e,this.getZ());if(i<this.getZ())if(r!==_t)this.sendMessage(this,"You can't go up here!");else if(i<0)this.sendMessage(this,"Sorry, these are fake stairs. No higher level.");else{const r=this.map.getUpstairPos()[this.getZ()],n=this.map.getDownstairPos()[i];let o;for(let i=0;i<r.length;i++)r[i][0]===t&&r[i][1]===e&&(o=i);const a=n[o][0],h=n[o][1];this.sendMessage(this,`You ascend to level ${i+1}!`),this.setPosition(a,h,i),s.currentZ=i}else if(i>this.getZ())if(r===bt&&this.hasMixin("PlayerActor"))this.switchMap(this.game.maps.bossCavern);else if(r!==mt)this.sendMessage(this,"You can't go down here!");else if(i>=s.depth)this.sendMessage(this,"Sorry, these are fake stairs. No lower level.");else{const r=this.map.getDownstairPos()[this.getZ()],n=this.map.getUpstairPos()[i];let o;for(let i=0;i<r.length;i++)r[i][0]===t&&r[i][1]===e&&(o=i);const a=n[o][0],h=n[o][1];this.sendMessage(this,`You descend to level ${i+1}!`),this.setPosition(a,h,i),s.currentZ=i}else{if(n)return!!(this.hasMixin("Attacker")&&this.hasMixin("PlayerActor")||n.hasMixin("PlayerActor"))&&(this.attack(n),!0);if(r.isWalkable()){this.setPosition(t,e,i);const s=this.getMap().getItemsAt(t,e,i);return s&&(1===s.length?this.sendMessage(this,`You see ${s[0].describeA()}.`):this.sendMessage(this,"You see several objects here.")),!0}if(r.isDiggable()&&this.hasMixin("PlayerActor"))return s.dig(t,e,i),!0}return!1}sendMessage(t,e){t.hasMixin("MessageRecipient")&&t.receiveMessage(e)}sendMessageNearby(t,e,i,s,r){t.getEntitiesWithinRadius(e,i,s,5).forEach(t=>{t.hasMixin("MessageRecipient")&&t.receiveMessage(r)})}}var Mt=i(38),St=i.n(Mt);class At{constructor(t,e){this.name=t,this.templates={},this.randomTemplates={},this.ctor=e}define(t,e,i){this.templates[t]=e,i&&i.disableRandomCreation||(this.randomTemplates[t]=e)}create(t,e){if(!this.templates[t])throw new Error(`No template named '${t}' in repository '${this.name}'`);const i=Object.assign({},this.templates[t]);if(e)for(const t in e)i[t]=e[t];return new this.ctor(i)}createRandom(){const t=Object.keys(this.randomTemplates);return this.create(t[Math.floor(Math.random()*t.length)])}}class Tt extends wt{}const Ct={};Ct.Edible={name:"Edible",init(t){this.foodValue=t.foodValue||5,this.maxConsumptions=t.consumptions||1,this.remainingConsumptions=this.maxConsumptions},listeners:{details(){return[{key:"food",value:this.foodValue}]}},eat(t){t.hasMixin("FoodConsumer")&&this.hasRemainingConsumptions()&&(t.modifyFullnessBy(this.foodValue),this.remainingConsumptions--)},hasRemainingConsumptions(){return this.remainingConsumptions>0},describe(){return this.maxConsumptions!=this.remainingConsumptions?`partly eaten ${Tt.prototype.describe.call(this)}`:this.name}},Ct.Equippable={name:"Equippable",init(t){this.attackValue=t.attackValue||0,this.defenseValue=t.defenseValue||0,this.wieldable=t.wieldable||!1,this.wearable=t.wearable||!1},listeners:{details(){const t=[];return this.wieldable&&t.push({key:"attack",value:this.getAttackValue()}),this.wearable&&t.push({key:"defense",value:this.getDefenseValue()}),t}},getAttackValue(){return this.attackValue},getDefenseValue(){return this.defenseValue},isWieldable(){return this.wieldable},isWearable(){return this.wearable}};var Et=Ct;const Pt=new At("items",Tt);Pt.define("corpse",{name:"corpse",character:"%",foodValue:75,consumptions:1,mixins:[Et.Edible]},{disableRandomCreation:!0}),Pt.define("apple",{name:"apple",character:"%",foreground:"red",foodValue:50,mixins:[Et.Edible]}),Pt.define("melon",{name:"melon",character:"%",foreground:"lightGreen",foodValue:35,consumptions:4,mixins:[Et.Edible]}),Pt.define("pumpkin",{name:"pumpkin of power",character:"%",foreground:"orange",foodValue:50,consumptions:5,attackValue:1,defenseValue:1,wearable:!0,wieldable:!0,mixins:[Et.Edible,Et.Equippable]}),Pt.define("dagger",{name:"dagger",character:")",foreground:"gray",attackValue:5,wieldable:!0,mixins:[Et.Equippable]},{disableRandomCreation:!0}),Pt.define("sword",{name:"sword",character:")",foreground:"white",attackValue:10,wieldable:!0,mixins:[Et.Equippable]},{disableRandomCreation:!0}),Pt.define("staff",{name:"staff",character:")",foreground:"yellow",attackValue:5,defenseValue:3,wieldable:!0,mixins:[Et.Equippable]},{disableRandomCreation:!0}),Pt.define("tunic",{name:"tunic",character:"[",foreground:"green",defenseValue:2,wearable:!0,mixins:[Et.Equippable]},{disableRandomCreation:!0}),Pt.define("chainmail",{name:"chainmail",character:"[",foreground:"white",defenseValue:4,wearable:!0,mixins:[Et.Equippable]},{disableRandomCreation:!0}),Pt.define("platemail",{name:"platemail",character:"[",foreground:"aliceblue",defenseValue:6,wearable:!0,mixins:[Et.Equippable]},{disableRandomCreation:!0});var Ot=Pt;const Rt={};Rt.Sight={name:"Sight",groupName:"Sight",init(t){this.sightRadius=t.sightRadius||5},getSightRadius(){return this.sightRadius},increaseSightRadius(t=1){this.sightRadius+=t,this.sendMessage(this,"You are more aware of your surroundings!")},canSee(t){if(!t||this.map!==t.getMap()||this.z!==t.getZ())return!1;const e=this.getX(),i=this.getY(),s=t.getX(),r=t.getY();if(Math.abs(s-e)>this.sightRadius||Math.abs(r-i)>this.sightRadius)return!1;let n=!1;return this.getMap().getFov(this.getZ()).compute(e,i,this.getSightRadius(),(t,e,i,o)=>{t===s&&e===r&&(n=!0)}),n}},Rt.PlayerActor={name:"PlayerActor",groupName:"Actor",act(){this.acting||(this.acting=!0,this.addTurnHunger(),this.isAlive()||(this.game.screens.playScreen.setGameEnded(!0),this.sendMessage(this,"You have died. Press [escape] to continue.")),this.game.refresh(),this.getMap().getEngine().lock(),this.clearMessages(),this.acting=!1)}},Rt.TaskActor={name:"TaskActor",groupName:"Actor",init(t){this.tasks=t.tasks||["wander"]},act(){if(this.getZ()!==this.map.currentZ)return!1;for(let t=0;t<this.tasks.length;t++)if(this.canDoTask(this.tasks[t]))return this[this.tasks[t]](),!0},canDoTask(t){if("hunt"===t)return this.hasMixin("Sight")&&this.canSee(this.getMap().getPlayer());if("wander"===t)return!0;throw new Error(`Tried to perform undefined task ${t}`)},hunt(){const t=this.getMap().getPlayer(),e=this.getX(),i=this.getY(),s=this.getZ(),r=t.getY(),n=t.getX();if(1===Math.abs(n-e)+Math.abs(r-i)&&this.hasMixin("Attacker"))return void this.attack(t);const o=new L.AStar(n,r,(e,i)=>{const r=this.getMap().getEntityAt(e,i,s);return(!r||r===t||r===this)&&this.getMap().getTile(e,i,s).isWalkable()},{topology:8});let a=0;o.compute(e,i,(t,e)=>{1===a&&this.tryMove(t,e),a++})},wander(){const t=Math.random()>=.5?1:-1,e=this.getX(),i=this.getY();Math.random()>=.5?this.tryMove(e+t,i):this.tryMove(e,i+t)}},Rt.FungusActor={name:"FungusActor",groupName:"Actor",init(){this.growthsRemaining=5},act(){if(this.getZ()!==this.map.currentZ)return!1;if(this.growthsRemaining>0&&Math.random()<=.03){const t=Math.floor(3*Math.random())-1,e=Math.floor(3*Math.random())-1;if((0!==t||0!==e)&&this.getMap().isEmptyFloor(this.getX()+t,this.getY()+e,this.getZ())){const i=Dt.create("fungus");i.setPosition(this.getX()+t,this.getY()+e,this.getZ()),this.getMap().addEntity(i),this.growthsRemaining--,this.sendMessageNearby(this.getMap(),i.getX(),i.getY(),i.getZ(),"The fungus is spreading!")}}}},Rt.GiantZombieActor=St()({},Rt.TaskActor,{init(t){Rt.TaskActor.init.call(this,t),this.hasGrownArm=!1},listeners:{onDeath(t){t.game.switchScreen(t.game.screens.winScreen)}},canDoTask(t){return"growArm"===t?this.getHP()<=20&&!this.hasGrownArm:"spawnSlime"===t?Math.random()<=.1:Rt.TaskActor.canDoTask.call(this,t)},growArm(){this.hasGrownArm=!0,this.increaseAttackValue(5),this.sendMessageNearby(this.getMap(),this.getX(),this.getY(),this.getZ(),"The giant zombie has grown an extra arm!")},spawnSlime(){const t=this.getX(),e=this.getY(),i=this.getZ();let s=Math.floor(3*Math.random())-1,r=Math.floor(3*Math.random())-1,n=0;for(;n<10&&!this.getMap().isEmptyFloor(t+s,e+r,i);)s=Math.floor(3*Math.random())-1,r=Math.floor(3*Math.random())-1,n++;if(!this.getMap().isEmptyFloor(t+s,e+r,i))return canDoTask("hunt")?void this.hunt():void this.wander();const o=Dt.create("slime");o.setPosition(t+s,e+r,i),this.getMap().addEntity(o)}}),Rt.Destructible={name:"Destructible",init(t){this.maxHP=t.maxHP||10,this.hp=t.hp||this.maxHP,this.defenseValue=t.defenseValue||0},listeners:{details(){return[{key:"defense",value:this.getDefenseValue()},{key:"hp",value:this.getHP()}]},onGainLevel(){this.setHP(this.getMaxHP())}},getHP(){return this.hp},setHP(t){this.hp=t},getMaxHP(){return this.maxHP},increaseMaxHP(t=10){this.maxHP+=t,this.hp+=t,this.sendMessage(this,"You look healthier!")},getDefenseValue(){let t=0;return this.hasMixin(Rt.Equipper)&&(this.getWeapon()&&(t+=this.getWeapon().getDefenseValue()),this.getArmor()&&(t+=this.getArmor().getDefenseValue())),this.defenseValue+t},increaseDefenseValue(t=2){this.defenseValue+=t,this.sendMessage(this,"You look tougher!")},takeDamage(t,e){this.hp-=e,this.hp<=0&&(this.sendMessage(t,`You kill the ${this.getName()}`),this.raiseEvent("onDeath",t),t.raiseEvent("onKill",this),this.kill("You have been killed to death."))}},Rt.Attacker={name:"Attacker",groupName:"Attacker",init(t){this.attackValue=t.attackValue||1},listeners:{details(){return[{key:"attack",value:this.getAttackValue()}]}},getAttackValue(){let t=0;return this.hasMixin(Rt.Equipper)&&(this.getWeapon()&&(t+=this.getWeapon().getAttackValue()),this.getArmor()&&(t+=this.getArmor().getAttackValue())),this.attackValue+t},increaseAttackValue(t=2){this.attackValue+=t,this.sendMessage(this,"You look stronger!")},attack(t){if(t.hasMixin("Destructible")){const e=this.getAttackValue(),i=t.getDefenseValue(),s=Math.max(0,e-i),r=1+Math.floor(Math.random()*s);this.sendMessage(this,`You strike the ${t.getName()} for ${r} damage!`),this.sendMessage(t,`The ${this.getName()} strikes you for ${r} damage!`),t.takeDamage(this,r)}}},Rt.InventoryHolder={name:"InventoryHolder",init(t){const e=t.inventorySlots||10;this.items=new Array(e)},getItems(){return this.items},getItem(t){return this.items[t]},addItem(t){for(let e=0;e<this.items.length;e++)if(!this.items[e])return this.items[e]=t,!0;return!1},removeItem(t){this.items[t]&&this.hasMixin(Rt.Equipper)&&this.unequip(this.items[t]),this.items[t]=null},canAddItem(){for(let t=0;t<this.items.length;t++)if(!this.items[t])return!0;return!1},pickupItems(t){const e=this.map.getItemsAt(this.getX(),this.getY(),this.getZ());let i=0;for(let s=0;s<t.length&&this.addItem(e[t[s]-i]);s++)e.splice(t[s]-i,1),i++;return this.map.setItemsAt(this.getX(),this.getY(),this.getZ(),e),i===t.length},dropItem(t){this.items[t]&&(this.map&&this.map.addItem(this.getX(),this.getY(),this.getZ(),this.items[t]),this.removeItem(t))}},Rt.MessageRecipient={name:"MessageRecipient",init(t){this.messages=[]},receiveMessage(t){this.messages.push(t)},getMessages(){return this.messages},clearMessages(){this.messages=[]}},Rt.ExperienceGainer={name:"ExperienceGainer",init(t){this.level=t.level||1,this.experience=t.experience||0,this.statPointsPerLevel=t.statPointsPerLevel||1,this.statPoints=0,this.statOptions=[],this.hasMixin("Attacker")&&this.statOptions.push(["Increase attack value",this.increaseAttackValue.bind(this),this.getAttackValue.bind(this)]),this.hasMixin("Destructible")&&(this.statOptions.push(["Increase defense value",this.increaseDefenseValue.bind(this),this.getDefenseValue.bind(this)]),this.statOptions.push(["Increase max health",this.increaseMaxHP.bind(this),this.getMaxHP.bind(this)])),this.hasMixin("Sight")&&this.statOptions.push(["Increase sight range",this.increaseSightRadius.bind(this),this.getSightRadius.bind(this)])},listeners:{details(){return[{key:"level",value:this.getLevel()}]},onKill(t){let e=t.getMaxHP()+t.getDefenseValue();t.hasMixin("Attacker")&&(e+=t.getAttackValue()),t.hasMixin("ExperienceGainer")&&(e-=3*(this.getLevel()-t.getLevel())),e>0&&this.giveExperience(e)}},getLevel(){return this.level},getExperience(){return this.experience},getNextLevelExperience(){return this.level*this.level*10},getStatPoints(){return this.statPoints},setStatPoints(t){this.statPoints=t},getStatOptions(){return this.statOptions},giveExperience(t){let e=0,i=0;for(;t>0;)if(this.experience+t>=this.getNextLevelExperience()){const s=this.getNextLevelExperience()-this.experience;t-=s,this.experience+=s,this.level++,i++,this.statPoints+=this.statPointsPerLevel,e+=this.statPointsPerLevel}else this.experience+=t,t=0;i>0&&(this.sendMessage(this,`You advance to level ${this.level}.`),this.raiseEvent("onGainLevel"))}},Rt.FoodConsumer={name:"FoodConsumer",init(t){this.maxFullness=t.maxFullness||1e3,this.fullness=t.fullness||this.maxFullness/2,this.fullnessDepletionRate=t.fullnessDepletionRate||1},addTurnHunger(){this.modifyFullnessBy(-this.fullnessDepletionRate)},modifyFullnessBy(t){this.fullness=this.fullness+t,this.fullness<=0?this.kill("You have died of starvation!"):this.fullness>this.maxFullness&&this.kill("You have died of overindulgence.")},getHungerState(){const t=this.maxFullness/100;return this.fullness<=5*t?"Starving":this.fullness<=25*t?"Hungry":this.fullness>=95*t?"Stuffed to Death":this.fullness>=75*t?"Full":"Not Hungry"}},Rt.PlayerStatGainer={name:"PlayerStatGainer",groupName:"StatGainer",listeners:{onGainLevel(){this.game.screens.gainStatScreen.setup(this),this.game.screens.playScreen.setSubScreen(this.game.screens.gainStatScreen)}}},Rt.RandomStatGainer={name:"RandomStatGainer",groupName:"StatGainer",listeners:{onGainLevel(){const t=this.getStatOptions();for(;this.getStatPoints()>0;)t[Math.floor(Math.random()*t.length)][1](),this.setStatPoints(this.getStatPoints()-1)}}},Rt.CorpseDropper={name:"CorpseDropper",init(t){this.corpseDropRate=t.corpseDropRate||100},listeners:{onDeath(t){Math.round(100*Math.random())<=this.corpseDropRate&&this.map.addItem(this.getX(),this.getY(),this.getZ(),Ot.create("corpse",{name:`${this.name} corpse`,foreground:this.foreground}))}}},Rt.Equipper={name:"Equipper",init(t){this.weapon=null,this.armor=null},wield(t){this.weapon=t},unwield(){this.weapon=null},wear(t){this.armor=t},takeOff(){this.armor=null},getWeapon(){return this.weapon},getArmor(){return this.armor},unequip(t){this.weapon===t?this.unwield():this.armor===t&&this.takeOff()}};const It={name:"human (you)",character:"@",foreground:"white",maxHP:15,attackValue:5,defenseValue:2,sightRadius:6,inventorySlots:22,mixins:[Rt.PlayerActor,Rt.Sight,Rt.Attacker,Rt.Destructible,Rt.MessageRecipient,Rt.InventoryHolder,Rt.FoodConsumer,Rt.Equipper,Rt.ExperienceGainer,Rt.PlayerStatGainer]},Dt=new At("entities",kt);Dt.define("bat",{name:"bat",character:"B",foreground:"white",maxHP:3,speed:2e3,attackValue:2,corpseDropRate:50,mixins:[Rt.TaskActor,Rt.CorpseDropper,Rt.Attacker,Rt.Destructible,Rt.ExperienceGainer,Rt.RandomStatGainer]}),Dt.define("newt",{name:"newt",character:":",foreground:"yellow",maxHP:5,attackValue:2,corpseDropRate:75,mixins:[Rt.TaskActor,Rt.CorpseDropper,Rt.Attacker,Rt.Destructible,Rt.ExperienceGainer,Rt.RandomStatGainer]}),Dt.define("kobold",{name:"kobold",character:"k",foreground:"white",maxHP:6,attackValue:4,sightRadius:5,tasks:["hunt","wander"],mixins:[Rt.TaskActor,Rt.Sight,Rt.Attacker,Rt.Destructible,Rt.ExperienceGainer,Rt.RandomStatGainer,Rt.CorpseDropper]}),Dt.define("fungus",{name:"fungus",character:"F",foreground:"green",speed:250,maxHP:6,corpseDropRate:10,mixins:[Rt.FungusActor,Rt.Destructible,Rt.ExperienceGainer,Rt.RandomStatGainer,Rt.CorpseDropper]}),Dt.define("slime",{name:"slime",character:"s",foreground:"lightGreen",maxHP:10,attackValue:5,sightRadius:3,tasks:["hunt","wander"],mixins:[Rt.TaskActor,Rt.Sight,Rt.Attacker,Rt.Destructible,Rt.ExperienceGainer,Rt.RandomStatGainer,Rt.CorpseDropper]}),Dt.define("giant zombie",{name:"giant zombie",character:"Z",foreground:"teal",maxHP:30,attackValue:8,defenseValue:5,level:5,sightRadius:6,tasks:["growArm","spawnSlime","hunt","wander"],mixins:[Rt.GiantZombieActor,Rt.Sight,Rt.Attacker,Rt.Destructible,Rt.CorpseDropper,Rt.ExperienceGainer]},{disableRandomCreation:!0});class Yt{constructor(t,e,i){this.width=t,this.height=e,this.depth=i,this.tiles=[],this.allUpstairPos=[],this.allDownstairPos=[];for(let t=0;t<i;t++){const t=this.generateLevel(),e=t[0],i=t[1],s=t[2];this.tiles.push(e),this.allUpstairPos.push(i),this.allDownstairPos.push(s)}}getTiles(){return this.tiles}getAllUpstairPos(){return this.allUpstairPos}getAllDownstairPos(){return this.allDownstairPos}getDepth(){return this.depth}getWidth(){return this.width}getHeight(){return this.height}generateLevel(){const t=[],e=[],i=[],s=[];for(let e=0;e<this.width;e++)t.push([]);new H.Digger(this.width,this.height).create((i,s,r)=>{r?t[i][s]=ft:(t[i][s]=gt,e.push([i,s]))});for(let s=0;s<3;s++){const s=Math.floor(Math.random()*e.length),r=e[s];e.splice(s,1),t[r[0]][r[1]]=_t,i.push(r)}for(let i=0;i<3;i++){const i=Math.floor(Math.random()*e.length),r=e[i];e.splice(i,1),t[r[0]][r[1]]=mt,s.push(r)}return[t,i,s]}}class jt{constructor(t){this.tiles=t,this.depth=t.length,this.width=t[0].length,this.height=t[0][0].length,this.currentZ=0,this.fov=[],this.setupFov(),this.exploredTiles=[],this.setupExploredArray(),this.entities={};for(let t=0;t<this.depth;t++)this.entities[t]={};this.items={};for(let t=0;t<this.depth;t++)this.items[t]={};this.scheduler=new P.Speed,this.engine=new U(this.scheduler)}getEngine(){return this.engine}getPlayer(){return this.player}getEntities(){return this.entities}getEntityAt(t,e,i){return!!this.entities[i]&&this.entities[i][`${t},${e}`]}getWidth(){return this.width}getHeight(){return this.height}getDepth(){return this.depth}getTile(t,e,i){return t<0||t>=this.width||e<0||e>=this.height||i<0||i>=this.depth?dt:this.tiles[i][t][e]||dt}dig(t,e,i){this.getTile(t,e,i).isDiggable()&&(this.tiles[i][t][e]=gt)}getRandomFloorPosition(t){let e,i;do{e=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.width)}while(!this.isEmptyFloor(e,i,t));return{x:e,y:i,z:t}}addEntity(t){t.setMap(this),this.updateEntityPosition(t),t.hasMixin("Actor")&&this.scheduler.add(t,!0),t.hasMixin("PlayerActor")&&(this.player=t)}addEntityAtRandomPosition(t,e){const i=this.getRandomFloorPosition(e);t.setX(i.x),t.setY(i.y),t.setZ(i.z),this.addEntity(t)}destroyEntity(t){this.removeEntity(t),t.hasMixin("Actor")&&this.scheduler.remove(t),t.hasMixin("PlayerActor")&&(this.player=void 0)}removeEntity(t){const e=`${t.getX()},${t.getY()}`,i=t.getZ();this.entities[i][e]===t&&delete this.entities[i][e]}isEmptyFloor(t,e,i){return this.getTile(t,e,i)===gt&&!this.getEntityAt(t,e,i)}getEntitiesWithinRadius(t,e,i,s){const r=[],n=t-s,o=t+s,a=e-s,h=e+s;for(const t in this.entities[i]){const e=this.entities[i][t];e.getX()>=n&&e.getX()<=o&&e.getY()>=a&&e.getY()<=h&&r.push(e)}return r}updateEntityPosition(t,e,i,s){if("number"==typeof e){const r=`${e},${i}`;this.entities[s][r]===t&&delete this.entities[s][r]}const r=t.getX(),n=t.getY(),o=t.getZ();if(r<0||r>=this.width||n<0||n>=this.height||o<0||o>=this.depth)throw new Error("Entity's position is out of bounds.");const a=`${r},${n}`;if(this.entities[o][a])throw new Error("Tried to add an entity at an occupied position.");this.entities[o][a]=t}setupFov(){for(let t=0;t<this.depth;t++)this.fov.push(new I.DiscreteShadowcasting((e,i)=>!this.getTile(e,i,t).isBlockingLight(),{topology:8}))}getFov(t){return this.fov[t]}setupExploredArray(){for(let t=0;t<this.depth;t++){this.exploredTiles[t]=[];for(let e=0;e<this.width;e++){this.exploredTiles[t][e]=[];for(let i=0;i<this.height;i++)this.exploredTiles[t][e][i]=!1}}}setExplored(t,e,i,s){this.getTile(t,e,i)!==dt&&(this.exploredTiles[i][t][e]=s)}isExplored(t,e,i){return this.getTile(t,e,i)!==dt&&this.exploredTiles[i][t][e]}getItemsAt(t,e,i){return this.items[i][`${t},${e}`]}setItemsAt(t,e,i,s){const r=`${t},${e}`;0===s.length?this.items[i][r]&&delete this.items[i][r]:this.items[i][r]=s}addItem(t,e,i,s){const r=`${t},${e}`;this.items[i][r]?this.items[i][r].push(s):this.items[i][r]=[s]}addItemAtRandomPosition(t,e){const i=this.getRandomFloorPosition(e);this.addItem(i.x,i.y,i.z,t)}}class Wt extends jt{constructor(t,e,i){super(t),this.upstairPos=e,this.downstairPos=i;for(let t=0;t<this.depth;t++){for(let e=0;e<25;e++){const e=Dt.createRandom();if(this.addEntityAtRandomPosition(e,t),e.hasMixin("ExperienceGainer"))for(let i=0;i<t;i++)e.giveExperience(e.getNextLevelExperience()-e.getExperience())}for(let e=0;e<10;e++)this.addItemAtRandomPosition(Ot.createRandom(),t)}const s=["dagger","sword","staff","tunic","chainmail","platemail"];for(let t=0;t<s.length;t++)this.addItemAtRandomPosition(Ot.create(s[t]),Math.floor(this.depth*Math.random()));const r=this.getRandomFloorPosition(this.depth-1);this.tiles[this.depth-1][r.x][r.y]=bt}getUpstairPos(){return this.upstairPos}getDownstairPos(){return this.downstairPos}}class Xt{fillCircle(t,e,i,s,r){let n=s,o=0,a=1-(s<<1),h=0,l=0;for(;n>=o;){for(let s=e-n;s<=e+n;s++)t[s][i+o]=r,t[s][i-o]=r;for(let s=e-o;s<=e+o;s++)t[s][i+n]=r,t[s][i-n]=r;o++,l+=h,h+=2,(l<<1)+a>0&&(n--,l+=a,a+=2)}}generateTiles(t,e){const i=[];for(let s=0;s<t;s++){i[s]=[];for(let t=0;t<e;t++)i[s][t]=ft}const s=(Math.min(t,e)-2)/2;this.fillCircle(i,t/2,e/2,s,gt);const r=Math.round(5*Math.random())+5;for(let s=0;s<r;s++){let s=Math.floor(Math.random()*(t-6)),r=Math.floor(Math.random()*(e-6));s+=3,r+=3;const n=Math.floor(3*Math.random())+1;this.fillCircle(i,s,r,n,yt)}return[i]}}class $t extends jt{constructor(){super(Xt.prototype.generateTiles(80,40)),this.addEntityAtRandomPosition(Dt.create("giant zombie"),0)}}class zt{constructor(){const t=new Yt(100,100,6),e=t.getTiles(),i=t.getAllUpstairPos(),s=t.getAllDownstairPos();this.player=new kt(It,this),this.maps={dungeon:new Wt(e,i,s),bossCavern:new $t},this.maps.dungeon.addEntityAtRandomPosition(this.player,0),this.screenWidth=80,this.screenHeight=40,this.display=new T({width:this.screenWidth,height:this.screenHeight+1}),document.body.appendChild(this.display.getContainer()),this.screens={startScreen:B,playScreen:K,winScreen:J,loseScreen:Q,inventoryScreen:et,dropScreen:st,pickupScreen:it,eatScreen:rt,wieldScreen:nt,wearScreen:ot,examineScreen:at,gainStatScreen:ht,lookScreen:lt,helpScreen:ct},this.screens.playScreen.player=this.player,this.screens.playScreen.game=this,this.screens.startScreen.game=this,this.screens.helpScreen.game=this,this.screens.startScreen.handleEvent=this.screens.startScreen.handleEvent.bind(this.screens.startScreen),this.screens.playScreen.handleEvent=this.screens.playScreen.handleEvent.bind(this.screens.playScreen),this.switchScreen(this.screens.startScreen)}getDisplay(){return this.display}getScreenWidth(){return this.screenWidth}getScreenHeight(){return this.screenHeight}switchScreen(t){this.currentScreen&&(window.removeEventListener("keydown",this.currentScreen),this.currentScreen.exit()),this.getDisplay().clear(),this.currentScreen=t,this.currentScreen&&(this.currentScreen.enter(this),this.refresh()),window.addEventListener("keydown",this.currentScreen)}refresh(){this.display.clear(),this.currentScreen.render(this.display)}}document.addEventListener("DOMContentLoaded",()=>{new zt})}]);